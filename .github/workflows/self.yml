on: [push]
name: self
jobs:


  bin:
    runs-on: ubuntu-latest
    steps:
    - run: docker buildx version
    - run: DOCKER_BUILDKIT=1 docker --help
    - run: docker buildx bake --help
    - run: docker buildx build --help

    - uses: actions-rs/toolchain@v1
      with:
        profile: minimal
        toolchain: stable

    - uses: actions/checkout@v4

    - name: Cache `cargo fetch`
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
        key: ${{ github.job }}-${{ runner.os }}-cargo-deps-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: ${{ github.job }}-${{ runner.os }}-cargo-deps-

    - name: Cache `cargo install`
      uses: actions/cache@v4
      with:
        path: ~/instmp
        key: ${{ runner.os }}-cargo-install-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-install-

    - name: Compile HEAD cargo-green
      run: |
        CARGO_TARGET_DIR=~/instmp cargo install --locked --force --path=./cargo-green

    - uses: actions/upload-artifact@v4
      with:
        name: bin-artifacts
        path: /home/runner/.cargo/bin/cargo-green


  installs:
    runs-on: ubuntu-latest
    needs: bin
    steps:
    - uses: actions-rs/toolchain@v1
      with:
        profile: minimal
        toolchain: stable

    - name: Retrieve saved bin
      uses: actions/download-artifact@v4
      with:
        name: bin-artifacts
    - run: | # TODO: whence https://github.com/actions/download-artifact/issues/236
        chmod +x ./cargo-green
        ./cargo-green --version | grep cargo-green
        mv ./cargo-green /home/runner/.cargo/bin/
        cargo green --version

    - uses: actions/checkout@v4

    - name: cargo install net=ON cache=OFF remote=OFF jobs=1
      run: |
        CARGOGREEN_LOG=debug \
        RUSTCBUILDX_LOG_PATH="$PWD"/logs.txt \
          CARGO_TARGET_DIR=~/instst cargo green -vv install --jobs=1 --locked --force --path=./cargo-green |& tee _

    - if: ${{ failure() || success() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F "thread 'main' panicked at src/cargo/util/dependency_queue.rs:" _

    - if: ${{ failure() || success() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' logs.txt

    - if: ${{ failure() || success() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' logs.txt

    - if: ${{ failure() || success() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' logs.txt

    - if: ${{ failure() || success() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' logs.txt

    - if: ${{ failure() || success() }}
      run: tail -n9999999 logs.txt ; echo >logs.txt


  audits:
    runs-on: ubuntu-latest
    needs: bin
    steps:
    - uses: actions-rs/toolchain@v1
      with:
        profile: minimal
        toolchain: stable

    - name: Retrieve saved bin
      uses: actions/download-artifact@v4
      with:
        name: bin-artifacts
    - run: | # TODO: whence https://github.com/actions/download-artifact/issues/236
        chmod +x ./cargo-green
        ./cargo-green --version | grep cargo-green
        mv ./cargo-green /home/runner/.cargo/bin/
        cargo green --version

    - uses: actions/checkout@v4

    - name: Cache `cargo fetch`
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
        key: ${{ github.job }}-${{ runner.os }}-cargo-deps-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: ${{ github.job }}-${{ runner.os }}-cargo-deps-

    - uses: taiki-e/install-action@v2
      with:
        tool: cargo-audit

    - name: cargo audit net=ON cache=OFF remote=OFF
      run: |
        CARGOGREEN_LOG=debug \
        RUSTCBUILDX_LOG_PATH="$PWD"/logs.txt \
          cargo green -vv audit |& tee _

    - if: ${{ failure() || success() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F "thread 'main' panicked at src/cargo/util/dependency_queue.rs:" _

    - if: ${{ failure() || success() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' logs.txt

    - if: ${{ failure() || success() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' logs.txt

    - if: ${{ failure() || success() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' logs.txt

    - if: ${{ failure() || success() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' logs.txt

    - if: ${{ failure() || success() }}
      run: tail -n9999999 logs.txt ; echo >logs.txt


  udeps:
    runs-on: ubuntu-latest
    needs: bin
    steps:
    - uses: actions-rs/toolchain@v1
      with:
        profile: minimal
        toolchain: nightly

    - name: Retrieve saved bin
      uses: actions/download-artifact@v4
      with:
        name: bin-artifacts
    - run: | # TODO: whence https://github.com/actions/download-artifact/issues/236
        chmod +x ./cargo-green
        ./cargo-green --version | grep cargo-green
        mv ./cargo-green /home/runner/.cargo/bin/
        cargo green --version

    - uses: actions/checkout@v4

    - name: Cache `cargo fetch`
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
        key: ${{ github.job }}-${{ runner.os }}-cargo-deps-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: ${{ github.job }}-${{ runner.os }}-cargo-deps-

    - uses: taiki-e/install-action@v2
      with:
        tool: cargo-udeps

    - name: cargo +nightly green udeps --all-targets --jobs=1 cache=OFF remote=OFF
      run: |
        CARGOGREEN_LOG=debug \
        RUSTCBUILDX_LOG_PATH="$PWD"/logs.txt \
          cargo +nightly green udeps --all-targets --jobs=1 |& tee _

    - if: ${{ failure() || success() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F "thread 'main' panicked at src/cargo/util/dependency_queue.rs:" _

    - if: ${{ failure() || success() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' logs.txt

    - if: ${{ failure() || success() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' logs.txt

    - if: ${{ failure() || success() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' logs.txt

    - if: ${{ failure() || success() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' logs.txt

    - if: ${{ failure() || success() }}
      run: tail -n9999999 logs.txt ; echo >logs.txt

    - name: cargo green +nightly udeps --all-targets --jobs=1 cache=ON remote=OFF
      run: |
        CARGOGREEN_LOG=debug \
        RUSTCBUILDX_LOG_PATH="$PWD"/logs.txt \
          cargo green +nightly udeps --all-targets --jobs=1


  builds:
    runs-on: ubuntu-latest
    needs: bin
    steps:
    - uses: actions-rs/toolchain@v1
      with:
        profile: minimal
        toolchain: stable

    - name: Retrieve saved bin
      uses: actions/download-artifact@v4
      with:
        name: bin-artifacts
    - run: | # TODO: whence https://github.com/actions/download-artifact/issues/236
        chmod +x ./cargo-green
        ./cargo-green --version | grep cargo-green
        mv ./cargo-green /home/runner/.cargo/bin/
        cargo green --version

    - uses: actions/checkout@v4

    - name: Cache `cargo fetch`
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
        key: ${{ github.job }}-${{ runner.os }}-cargo-deps-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: ${{ github.job }}-${{ runner.os }}-cargo-deps-

    - run: cargo fetch

    - name: cargo build net=OFF cache=OFF remote=OFF jobs=1
      run: |
        CARGOGREEN_LOG=debug \
        RUSTCBUILDX_LOG_PATH="$PWD"/logs.txt \
          cargo green -vv build --jobs=1 --all-targets --all-features --locked --frozen --offline |& tee _

    - if: ${{ failure() || success() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F "thread 'main' panicked at src/cargo/util/dependency_queue.rs:" _

    - if: ${{ failure() || success() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' logs.txt

    - if: ${{ failure() || success() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' logs.txt

    - if: ${{ failure() || success() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' logs.txt

    - if: ${{ failure() || success() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' logs.txt

    - if: ${{ failure() || success() }}
      run: tail -n9999999 logs.txt ; echo >logs.txt

    - name: Ensure running the same command twice without modifications does not recompile anything
      run: |
        CARGOGREEN_LOG=debug \
        RUSTCBUILDX_LOG_PATH="$PWD"/logs.txt \
          cargo green -vv build --jobs=1 --all-targets --all-features --locked --frozen --offline |& tee _
        cat _ | grep Finished | grep 0...s
        cat _ | grep Fresh
        ! cat _ | grep Compiling
        ! cat _ | grep 'DEBUG|INFO|WARN|ERROR'

    - if: ${{ failure() || success() }}
      run: cat logs.txt && echo >logs.txt

    - name: Ensure running the same command twice without modifications does not recompile anything (jobs>1)
      run: |
        CARGOGREEN_LOG=debug \
        RUSTCBUILDX_LOG_PATH="$PWD"/logs.txt \
          cargo green -vv build --jobs=$(nproc) --all-targets --all-features --locked --frozen --offline |& tee _
        cat _ | grep Finished | grep 0...s
        cat _ | grep Fresh
        ! cat _ | grep Compiling
        ! cat _ | grep 'DEBUG|INFO|WARN|ERROR'

    - if: ${{ failure() || success() }}
      run: cat logs.txt && echo >logs.txt


  tests:
    runs-on: ubuntu-latest
    needs: bin
    steps:
    - uses: actions-rs/toolchain@v1
      with:
        profile: minimal
        toolchain: stable

    - name: Retrieve saved bin
      uses: actions/download-artifact@v4
      with:
        name: bin-artifacts
    - run: | # TODO: whence https://github.com/actions/download-artifact/issues/236
        chmod +x ./cargo-green
        ./cargo-green --version | grep cargo-green
        mv ./cargo-green /home/runner/.cargo/bin/
        cargo green --version

    - uses: actions/checkout@v4

    - name: Cache `cargo fetch`
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
        key: ${{ github.job }}-${{ runner.os }}-cargo-deps-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: ${{ github.job }}-${{ runner.os }}-cargo-deps-

    - run: cargo fetch

    - name: cargo test net=OFF cache=OFF remote=OFF jobs=1
      run: |
        CARGOGREEN_LOG=debug \
        RUSTCBUILDX_LOG_PATH="$PWD"/logs.txt \
          cargo green -vv test --jobs=1 --all-targets --all-features --locked --frozen --offline |& tee _

    - if: ${{ failure() || success() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F "thread 'main' panicked at src/cargo/util/dependency_queue.rs:" _

    - if: ${{ failure() || success() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' logs.txt

    - if: ${{ failure() || success() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' logs.txt

    - if: ${{ failure() || success() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' logs.txt

    - if: ${{ failure() || success() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' logs.txt

    - if: ${{ failure() || success() }}
      run: tail -n9999999 logs.txt ; echo >logs.txt

    - name: Ensure running the same command twice without modifications does not recompile anything
      run: |
        CARGOGREEN_LOG=debug \
        RUSTCBUILDX_LOG_PATH="$PWD"/logs.txt \
          cargo green -vv test --jobs=1 --all-targets --all-features --locked --frozen --offline |& tee _
        cat _ | grep Finished | grep 0...s
        cat _ | grep Fresh
        ! cat _ | grep Compiling
        ! cat _ | grep 'DEBUG|INFO|WARN|ERROR'

    - if: ${{ failure() || success() }}
      run: cat logs.txt && echo >logs.txt

    - name: Ensure running the same command twice without modifications does not recompile anything (jobs>1)
      run: |
        CARGOGREEN_LOG=debug \
        RUSTCBUILDX_LOG_PATH="$PWD"/logs.txt \
          cargo green -vv test --jobs=$(nproc) --all-targets --all-features --locked --frozen --offline |& tee _
        cat _ | grep Finished | grep 0...s
        cat _ | grep Fresh
        ! cat _ | grep Compiling
        ! cat _ | grep 'DEBUG|INFO|WARN|ERROR'

    - if: ${{ failure() || success() }}
      run: cat logs.txt && echo >logs.txt


  checks:
    runs-on: ubuntu-latest
    needs: bin
    steps:
    - uses: actions-rs/toolchain@v1
      with:
        profile: minimal
        toolchain: stable

    - name: Retrieve saved bin
      uses: actions/download-artifact@v4
      with:
        name: bin-artifacts
    - run: | # TODO: whence https://github.com/actions/download-artifact/issues/236
        chmod +x ./cargo-green
        ./cargo-green --version | grep cargo-green
        mv ./cargo-green /home/runner/.cargo/bin/
        cargo green --version

    - uses: actions/checkout@v4

    - name: Cache `cargo fetch`
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
        key: ${{ github.job }}-${{ runner.os }}-cargo-deps-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: ${{ github.job }}-${{ runner.os }}-cargo-deps-

    - run: cargo fetch

    - name: cargo check net=OFF cache=OFF remote=OFF jobs=$(nproc)
      run: |
        CARGOGREEN_LOG=debug \
        RUSTCBUILDX_LOG_PATH="$PWD"/logs.txt \
          cargo green -vv check --jobs=$(nproc) --all-targets --all-features --locked --frozen --offline |& tee _

    - if: ${{ failure() || success() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F "thread 'main' panicked at src/cargo/util/dependency_queue.rs:" _

    - if: ${{ failure() || success() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' logs.txt

    - if: ${{ failure() || success() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' logs.txt

    - if: ${{ failure() || success() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' logs.txt

    - if: ${{ failure() || success() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' logs.txt

    - if: ${{ failure() || success() }}
      run: tail -n9999999 logs.txt ; echo >logs.txt

    - name: Ensure running the same command twice without modifications does not recompile anything
      run: |
        CARGOGREEN_LOG=debug \
        RUSTCBUILDX_LOG_PATH="$PWD"/logs.txt \
          cargo green -vv check --jobs=1 --all-targets --all-features --locked --frozen --offline |& tee _
        cat _ | grep Finished | grep 0...s
        cat _ | grep Fresh
        ! cat _ | grep Compiling
        ! cat _ | grep 'DEBUG|INFO|WARN|ERROR'

    - if: ${{ failure() || success() }}
      run: cat logs.txt && echo >logs.txt


  packages:
    runs-on: ubuntu-latest
    needs: bin
    steps:
    - uses: actions-rs/toolchain@v1
      with:
        profile: minimal
        toolchain: stable

    - name: Retrieve saved bin
      uses: actions/download-artifact@v4
      with:
        name: bin-artifacts
    - run: | # TODO: whence https://github.com/actions/download-artifact/issues/236
        chmod +x ./cargo-green
        ./cargo-green --version | grep cargo-green
        mv ./cargo-green /home/runner/.cargo/bin/
        cargo green --version

    - uses: actions/checkout@v4

    - name: Cache `cargo fetch`
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
        key: ${{ github.job }}-${{ runner.os }}-cargo-deps-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: ${{ github.job }}-${{ runner.os }}-cargo-deps-

    - run: cargo fetch

    - name: cargo package net=OFF cache=OFF remote=OFF jobs=1
      run: |
        CARGOGREEN_LOG=debug \
        RUSTCBUILDX_LOG_PATH="$PWD"/logs.txt \
          CARGO_TARGET_DIR=~/cargo-package cargo green -vv package --jobs=1 --all-features --locked --frozen --offline |& tee _

    - if: ${{ failure() || success() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F "thread 'main' panicked at src/cargo/util/dependency_queue.rs:" _

    - if: ${{ failure() || success() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' logs.txt

    - if: ${{ failure() || success() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' logs.txt

    - if: ${{ failure() || success() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' logs.txt

    - if: ${{ failure() || success() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' logs.txt

    - if: ${{ failure() || success() }}
      run: tail -n9999999 logs.txt ; echo >logs.txt


  clippy:
    runs-on: ubuntu-latest
    needs: bin
    steps:
    - uses: actions-rs/toolchain@v1
      with:
        profile: minimal
        toolchain: stable

    - run: rustup component add clippy

    - name: Retrieve saved bin
      uses: actions/download-artifact@v4
      with:
        name: bin-artifacts
    - run: | # TODO: whence https://github.com/actions/download-artifact/issues/236
        chmod +x ./cargo-green
        ./cargo-green --version | grep cargo-green
        mv ./cargo-green /home/runner/.cargo/bin/
        cargo green --version

    - uses: actions/checkout@v4

    - name: Cache `cargo fetch`
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
        key: ${{ github.job }}-${{ runner.os }}-cargo-deps-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: ${{ github.job }}-${{ runner.os }}-cargo-deps-

    - run: cargo fetch

    - name: cargo clippy net=OFF cache=OFF remote=OFF jobs=1
      run: |
        CARGOGREEN_LOG=debug \
        RUSTCBUILDX_LOG_PATH="$PWD"/logs.txt \
          cargo green -vv clippy --jobs=1 --all-targets --all-features --locked --frozen --offline |& tee _

    - if: ${{ failure() || success() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F "thread 'main' panicked at src/cargo/util/dependency_queue.rs:" _

    - if: ${{ failure() || success() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' logs.txt

    - if: ${{ failure() || success() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' logs.txt

    - if: ${{ failure() || success() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' logs.txt

    - if: ${{ failure() || success() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' logs.txt

    - if: ${{ failure() || success() }}
      run: tail -n9999999 logs.txt ; echo >logs.txt

    - name: Ensure running the same command twice without modifications does not recompile anything
      run: |
        CARGOGREEN_LOG=debug \
        RUSTCBUILDX_LOG_PATH="$PWD"/logs.txt \
          cargo green -vv clippy --jobs=$(nproc) --all-targets --all-features --locked --frozen --offline |& tee _
        cat _ | grep Finished | grep 0...s
        ! cat _ | grep 'Compiling|Compiling'
        ! cat _ | grep 'DEBUG|INFO|WARN|ERROR'

    - if: ${{ failure() || success() }}
      run: cat logs.txt && echo >logs.txt
