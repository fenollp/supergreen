on: [push]
name: CLIs
jobs:


  bin:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -euo pipefail {0}
    steps:
    - uses: actions/checkout@v6

    - uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: 1.91.1
        cache-on-failure: true
    - run: docker info
    - run: docker buildx version
    - run: docker buildx build --help
    - run: podman version || true
    - run: cargo -Vv

    - name: Cache `cargo fetch`
      uses: actions/cache@v5
      with:
        path: |
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
        key: ${{ github.job }}-${{ runner.os }}-cargo-deps-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: ${{ github.job }}-${{ runner.os }}-cargo-deps-

    - name: Cache `cargo install`
      uses: actions/cache@v5
      with:
        path: ~/instmp
        key: ${{ runner.os }}-cargo-install-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-install-

    - name: Compile HEAD cargo-green
      run: |
        CARGO_TARGET_DIR=~/instmp cargo install --locked --force --path=./cargo-green

    - uses: actions/upload-artifact@v7
      with:
        name: cargo-green
        path: /home/runner/.cargo/bin/cargo-green
        if-no-files-found: error

# $(login_to_readonly_hub)
#     - run: cargo green supergreen sync
#     - uses: actions-rust-lang/setup-rust-toolchain@v1
#       with:
#         toolchain: 1.90.0
#         cache-on-failure: true
#     - run: cargo green supergreen sync
# $(rundeps_versions)
#     - run: cargo green supergreen builder rm || true
#     - run: sudo du -sh $(cargo green supergreen sync data 2>/dev/null) || true
#     - run: sudo cp -r $(cargo green supergreen sync data 2>/dev/null) /home/runner/builder-cache || true
#     - run: sudo chown -R $(id -u):$(id -g) /home/runner/builder-cache
#     - run: du -sh /home/runner/builder-cache || true
#     - run: ls -lha /home/runner/builder-cache/ || true
#     - uses: actions/upload-artifact@v7
#       with:
#         name: builder-data
#         path: /home/runner/builder-cache
#         if-no-files-found: error

  buildxargs_master:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -euo pipefail {0}
    continue-on-error: ${{ matrix.toolchain != '1.91.1' }}
    strategy:
      matrix:
        toolchain:
        - 1.91.1
        - 1.90.0
        exclude:
        - toolchain: ${{ github.ref != 'refs/heads/main' && '1.91.1' }}
    env:
      CARGO_TARGET_DIR: /tmp/clis-buildxargs_master
    # CARGOGREEN_CACHE_FROM_IMAGES: docker-image://localhost:12345/${{ github.repository }}
    # CARGOGREEN_CACHE_TO_IMAGES: docker-image://localhost:23456/${{ github.repository }}
      CARGOGREEN_FINAL_PATH: recipes/buildxargs@master.Dockerfile
      CARGOGREEN_EXPERIMENT: finalpathnonprimary # dumps on each build call
      CARGOGREEN_LOG: trace
      CARGOGREEN_LOG_PATH: logs.txt

    needs: bin
    steps:
    - uses: docker/login-action@v3
      if: ${{ ! startsWith(github.ref, 'refs/heads/dependabot/') }}
      with:
        username: ${{ vars.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: ${{ matrix.toolchain }}
        rustflags: ''
        cache-on-failure: true


    - name: Retrieve saved bin
      uses: actions/download-artifact@v7
      with:
        name: cargo-green

    - name: Install saved bin
      shell: bash -eu {0}
      run: | # TODO: whence https://github.com/actions/download-artifact/issues/236
        chmod +x ./cargo-green
        { ! ./cargo-green --version ; } | grep cargo-green
        mv ./cargo-green ~/.cargo/bin/
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      name: Retrieve saved builder data
      uses: actions/download-artifact@v7
      with:
        name: builder-data
        path: /home/runner/builder-cache
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      run: |
        set -x
        sudo mkdir -p $(cargo green supergreen sync data 2>/dev/null)
        sudo mv -v /home/runner/builder-cache/* $(cargo green supergreen sync data 2>/dev/null)/
        sudo chown -R root:root $(cargo green supergreen sync data 2>/dev/null)
    - uses: actions/checkout@v6
    - run: docker info
    - run: docker buildx version
    - run: docker buildx build --help
    - run: podman version || true
    - run: cargo -Vv

    - name: Prepare local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # https://github.com/fenollp/supergreen/actions/caches
        mkdir -p /tmp/.local-registry
        mkdir -p /tmp/.local-registry-new
    - name: ðŸ”µ Restore local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      uses: actions/cache/restore@v5
      with:
        path: /tmp/.local-registry
        # github.run_id: https://github.com/actions/toolkit/issues/658#issuecomment-2640690759
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}
        restore-keys: |
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-
          localprivatereg-${{ runner.os }}-
          localprivatereg-

    - name: Pull regist3 image
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        false \
        || docker build --tag regist3 - <<<'FROM docker.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM mirror.gcr.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM public.ecr.aws/docker/registry:3' \
        || exit 1
    - name: Start "cache from" image registry
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' }}
      run: docker run --name=reg-from --rm --detach -p 12345:5000 --user $(id -u):$(id -g) -v     /tmp/.local-registry:/var/lib/registry regist3
    - name: Start "cache to" image registry
      if: ${{ env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: docker run --name=reg-to   --rm --detach -p 23456:5000 --user $(id -u):$(id -g) -v /tmp/.local-registry-new:/var/lib/registry regist3

    - name: ðŸ”µ Envs
      run: ~/.cargo/bin/cargo-green green supergreen env
    - if: ${{ matrix.toolchain != '1.91.1' }}
      run: ~/.cargo/bin/cargo-green green supergreen env CARGOGREEN_BASE_IMAGE | grep '${{ matrix.toolchain }}'
    - run: ~/.cargo/bin/cargo-green green supergreen builder
    - name: ðŸ”µ Envs again
      run: ~/.cargo/bin/cargo-green green supergreen env

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose
    - name: ðŸ”µ cargo install
      id: cargo-install
      continue-on-error: true
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --locked --force buildxargs --git https://github.com/fenollp/buildxargs.git |& tee _
    - name: ðŸ”µ cargo install jobs=1
      #if: ${{ job.steps.cargo-install.outcome == 'failure' }} this actually hides failure of cargo-install step
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --jobs=1 --locked --force buildxargs --git https://github.com/fenollp/buildxargs.git |& tee _
    - if: ${{ always() && matrix.toolchain != '1.91.1' }}
      uses: actions/upload-artifact@v7
      name: Upload recipe
      with:
        name: buildxargs@master.Dockerfile
        path: ${{ env.CARGOGREEN_FINAL_PATH }}
        if-no-files-found: error
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH
    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

    - name: ðŸ”µ Ensure running the same command twice without modifications...
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --locked --force buildxargs --git https://github.com/fenollp/buildxargs.git |& tee _
    - name: ...doesn't recompile anything
      run: |
        err=0
        grep Finished  _
        grep Finished  _ | grep -E [012]...s || ((err+=1))
        grep Dirty     _                     && ((err+=2))
        grep Compiling _                     && ((err+=4))
        exit $err
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH

    - name: ðŸ”µ Compare old/new local private registry image digests
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        diff --width=150 -y \
          <(find /tmp/.local-registry/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) \
          <(find /tmp/.local-registry-new/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) || true
        du -sh /tmp/.local-registry /tmp/.local-registry-new || true
    - name: Local private registry cache dance
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # [ci: caches keep growing](https://github.com/moby/buildkit/issues/1850)
        docker stop --timeout 10 reg-from reg-to
        rm -rf /tmp/.local-registry
        mv /tmp/.local-registry-new /tmp/.local-registry
    - name: Save local private registry cache
      uses: actions/cache/save@v5
      if: ${{ false }} # TODO: drop when digests are stable
      with:
        path: /tmp/.local-registry
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

  cargo-deny_0-18-5:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -euo pipefail {0}
    continue-on-error: ${{ matrix.toolchain != '1.91.1' }}
    strategy:
      matrix:
        toolchain:
        - 1.91.1
        - 1.90.0
        exclude:
        - toolchain: ${{ github.ref != 'refs/heads/main' && '1.91.1' }}
    env:
      CARGO_TARGET_DIR: /tmp/clis-cargo-deny_0-18-5
    # CARGOGREEN_CACHE_FROM_IMAGES: docker-image://localhost:12345/${{ github.repository }}
    # CARGOGREEN_CACHE_TO_IMAGES: docker-image://localhost:23456/${{ github.repository }}
      CARGOGREEN_FINAL_PATH: recipes/cargo-deny@0.18.5.Dockerfile
      CARGOGREEN_EXPERIMENT: finalpathnonprimary # dumps on each build call
      CARGOGREEN_LOG: trace
      CARGOGREEN_LOG_PATH: logs.txt

    needs: bin
    steps:
    - uses: docker/login-action@v3
      if: ${{ ! startsWith(github.ref, 'refs/heads/dependabot/') }}
      with:
        username: ${{ vars.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: ${{ matrix.toolchain }}
        rustflags: ''
        cache-on-failure: true


    - name: Retrieve saved bin
      uses: actions/download-artifact@v7
      with:
        name: cargo-green

    - name: Install saved bin
      shell: bash -eu {0}
      run: | # TODO: whence https://github.com/actions/download-artifact/issues/236
        chmod +x ./cargo-green
        { ! ./cargo-green --version ; } | grep cargo-green
        mv ./cargo-green ~/.cargo/bin/
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      name: Retrieve saved builder data
      uses: actions/download-artifact@v7
      with:
        name: builder-data
        path: /home/runner/builder-cache
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      run: |
        set -x
        sudo mkdir -p $(cargo green supergreen sync data 2>/dev/null)
        sudo mv -v /home/runner/builder-cache/* $(cargo green supergreen sync data 2>/dev/null)/
        sudo chown -R root:root $(cargo green supergreen sync data 2>/dev/null)
    - uses: actions/checkout@v6
    - run: docker info
    - run: docker buildx version
    - run: docker buildx build --help
    - run: podman version || true
    - run: cargo -Vv

    - name: Prepare local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # https://github.com/fenollp/supergreen/actions/caches
        mkdir -p /tmp/.local-registry
        mkdir -p /tmp/.local-registry-new
    - name: ðŸ”µ Restore local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      uses: actions/cache/restore@v5
      with:
        path: /tmp/.local-registry
        # github.run_id: https://github.com/actions/toolkit/issues/658#issuecomment-2640690759
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}
        restore-keys: |
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-
          localprivatereg-${{ runner.os }}-
          localprivatereg-

    - name: Pull regist3 image
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        false \
        || docker build --tag regist3 - <<<'FROM docker.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM mirror.gcr.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM public.ecr.aws/docker/registry:3' \
        || exit 1
    - name: Start "cache from" image registry
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' }}
      run: docker run --name=reg-from --rm --detach -p 12345:5000 --user $(id -u):$(id -g) -v     /tmp/.local-registry:/var/lib/registry regist3
    - name: Start "cache to" image registry
      if: ${{ env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: docker run --name=reg-to   --rm --detach -p 23456:5000 --user $(id -u):$(id -g) -v /tmp/.local-registry-new:/var/lib/registry regist3

    - name: ðŸ”µ Envs
      run: ~/.cargo/bin/cargo-green green supergreen env
    - if: ${{ matrix.toolchain != '1.91.1' }}
      run: ~/.cargo/bin/cargo-green green supergreen env CARGOGREEN_BASE_IMAGE | grep '${{ matrix.toolchain }}'
    - run: ~/.cargo/bin/cargo-green green supergreen builder
    - name: ðŸ”µ Envs again
      run: ~/.cargo/bin/cargo-green green supergreen env

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose
    - name: ðŸ”µ cargo install
      id: cargo-install
      continue-on-error: true
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --locked --force cargo-deny@0.18.5  |& tee _
    - name: ðŸ”µ cargo install jobs=1
      #if: ${{ job.steps.cargo-install.outcome == 'failure' }} this actually hides failure of cargo-install step
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --jobs=1 --locked --force cargo-deny@0.18.5  |& tee _
    - if: ${{ always() && matrix.toolchain != '1.91.1' }}
      uses: actions/upload-artifact@v7
      name: Upload recipe
      with:
        name: cargo-deny@0.18.5.Dockerfile
        path: ${{ env.CARGOGREEN_FINAL_PATH }}
        if-no-files-found: error
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH
    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

    - name: ðŸ”µ Ensure running the same command twice without modifications...
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --locked --force cargo-deny@0.18.5  |& tee _
    - name: ...doesn't recompile anything
      run: |
        err=0
        grep Finished  _
        grep Finished  _ | grep -E [012]...s || ((err+=1))
        grep Dirty     _                     && ((err+=2))
        grep Compiling _                     && ((err+=4))
        exit $err
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH

    - name: ðŸ”µ Compare old/new local private registry image digests
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        diff --width=150 -y \
          <(find /tmp/.local-registry/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) \
          <(find /tmp/.local-registry-new/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) || true
        du -sh /tmp/.local-registry /tmp/.local-registry-new || true
    - name: Local private registry cache dance
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # [ci: caches keep growing](https://github.com/moby/buildkit/issues/1850)
        docker stop --timeout 10 reg-from reg-to
        rm -rf /tmp/.local-registry
        mv /tmp/.local-registry-new /tmp/.local-registry
    - name: Save local private registry cache
      uses: actions/cache/save@v5
      if: ${{ false }} # TODO: drop when digests are stable
      with:
        path: /tmp/.local-registry
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

  cargo-llvm-cov_0-6-21:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -euo pipefail {0}
    continue-on-error: ${{ matrix.toolchain != '1.91.1' }}
    strategy:
      matrix:
        toolchain:
        - 1.91.1
        - 1.90.0
        exclude:
        - toolchain: ${{ github.ref != 'refs/heads/main' && '1.91.1' }}
    env:
      CARGO_TARGET_DIR: /tmp/clis-cargo-llvm-cov_0-6-21
    # CARGOGREEN_CACHE_FROM_IMAGES: docker-image://localhost:12345/${{ github.repository }}
    # CARGOGREEN_CACHE_TO_IMAGES: docker-image://localhost:23456/${{ github.repository }}
      CARGOGREEN_FINAL_PATH: recipes/cargo-llvm-cov@0.6.21.Dockerfile
      CARGOGREEN_EXPERIMENT: finalpathnonprimary # dumps on each build call
      CARGOGREEN_LOG: trace
      CARGOGREEN_LOG_PATH: logs.txt

    needs: bin
    steps:
    - uses: docker/login-action@v3
      if: ${{ ! startsWith(github.ref, 'refs/heads/dependabot/') }}
      with:
        username: ${{ vars.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: ${{ matrix.toolchain }}
        rustflags: ''
        cache-on-failure: true
    - run: rustup component add llvm-tools-preview

    - name: Retrieve saved bin
      uses: actions/download-artifact@v7
      with:
        name: cargo-green

    - name: Install saved bin
      shell: bash -eu {0}
      run: | # TODO: whence https://github.com/actions/download-artifact/issues/236
        chmod +x ./cargo-green
        { ! ./cargo-green --version ; } | grep cargo-green
        mv ./cargo-green ~/.cargo/bin/
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      name: Retrieve saved builder data
      uses: actions/download-artifact@v7
      with:
        name: builder-data
        path: /home/runner/builder-cache
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      run: |
        set -x
        sudo mkdir -p $(cargo green supergreen sync data 2>/dev/null)
        sudo mv -v /home/runner/builder-cache/* $(cargo green supergreen sync data 2>/dev/null)/
        sudo chown -R root:root $(cargo green supergreen sync data 2>/dev/null)
    - uses: actions/checkout@v6
    - run: docker info
    - run: docker buildx version
    - run: docker buildx build --help
    - run: podman version || true
    - run: cargo -Vv

    - name: Prepare local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # https://github.com/fenollp/supergreen/actions/caches
        mkdir -p /tmp/.local-registry
        mkdir -p /tmp/.local-registry-new
    - name: ðŸ”µ Restore local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      uses: actions/cache/restore@v5
      with:
        path: /tmp/.local-registry
        # github.run_id: https://github.com/actions/toolkit/issues/658#issuecomment-2640690759
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}
        restore-keys: |
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-
          localprivatereg-${{ runner.os }}-
          localprivatereg-

    - name: Pull regist3 image
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        false \
        || docker build --tag regist3 - <<<'FROM docker.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM mirror.gcr.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM public.ecr.aws/docker/registry:3' \
        || exit 1
    - name: Start "cache from" image registry
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' }}
      run: docker run --name=reg-from --rm --detach -p 12345:5000 --user $(id -u):$(id -g) -v     /tmp/.local-registry:/var/lib/registry regist3
    - name: Start "cache to" image registry
      if: ${{ env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: docker run --name=reg-to   --rm --detach -p 23456:5000 --user $(id -u):$(id -g) -v /tmp/.local-registry-new:/var/lib/registry regist3

    - name: ðŸ”µ Envs
      run: ~/.cargo/bin/cargo-green green supergreen env
    - if: ${{ matrix.toolchain != '1.91.1' }}
      run: ~/.cargo/bin/cargo-green green supergreen env CARGOGREEN_BASE_IMAGE | grep '${{ matrix.toolchain }}'
    - run: ~/.cargo/bin/cargo-green green supergreen builder
    - name: ðŸ”µ Envs again
      run: ~/.cargo/bin/cargo-green green supergreen env

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose
    - name: ðŸ”µ cargo install
      id: cargo-install
      continue-on-error: true
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --locked --force cargo-llvm-cov@0.6.21  |& tee _
    - name: ðŸ”µ cargo install jobs=1
      #if: ${{ job.steps.cargo-install.outcome == 'failure' }} this actually hides failure of cargo-install step
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --jobs=1 --locked --force cargo-llvm-cov@0.6.21  |& tee _
    - if: ${{ always() && matrix.toolchain != '1.91.1' }}
      uses: actions/upload-artifact@v7
      name: Upload recipe
      with:
        name: cargo-llvm-cov@0.6.21.Dockerfile
        path: ${{ env.CARGOGREEN_FINAL_PATH }}
        if-no-files-found: error
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH
    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

    - name: ðŸ”µ Ensure running the same command twice without modifications...
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --locked --force cargo-llvm-cov@0.6.21  |& tee _
    - name: ...doesn't recompile anything
      run: |
        err=0
        grep Finished  _
        grep Finished  _ | grep -E [012]...s || ((err+=1))
        grep Dirty     _                     && ((err+=2))
        grep Compiling _                     && ((err+=4))
        exit $err
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH

    - name: ðŸ”µ Compare old/new local private registry image digests
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        diff --width=150 -y \
          <(find /tmp/.local-registry/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) \
          <(find /tmp/.local-registry-new/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) || true
        du -sh /tmp/.local-registry /tmp/.local-registry-new || true
    - name: Local private registry cache dance
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # [ci: caches keep growing](https://github.com/moby/buildkit/issues/1850)
        docker stop --timeout 10 reg-from reg-to
        rm -rf /tmp/.local-registry
        mv /tmp/.local-registry-new /tmp/.local-registry
    - name: Save local private registry cache
      uses: actions/cache/save@v5
      if: ${{ false }} # TODO: drop when digests are stable
      with:
        path: /tmp/.local-registry
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

  cargo-nextest_0-9-114:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -euo pipefail {0}
    continue-on-error: ${{ matrix.toolchain != '1.91.1' }}
    strategy:
      matrix:
        toolchain:
        - 1.91.1
        - 1.90.0
        exclude:
        - toolchain: ${{ github.ref != 'refs/heads/main' && '1.91.1' }}
    env:
      CARGO_TARGET_DIR: /tmp/clis-cargo-nextest_0-9-114
    # CARGOGREEN_CACHE_FROM_IMAGES: docker-image://localhost:12345/${{ github.repository }}
    # CARGOGREEN_CACHE_TO_IMAGES: docker-image://localhost:23456/${{ github.repository }}
      CARGOGREEN_FINAL_PATH: recipes/cargo-nextest@0.9.114.Dockerfile
      CARGOGREEN_EXPERIMENT: finalpathnonprimary # dumps on each build call
      CARGOGREEN_LOG: trace
      CARGOGREEN_LOG_PATH: logs.txt

    needs: bin
    steps:
    - uses: docker/login-action@v3
      if: ${{ ! startsWith(github.ref, 'refs/heads/dependabot/') }}
      with:
        username: ${{ vars.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: ${{ matrix.toolchain }}
        rustflags: ''
        cache-on-failure: true


    - name: Retrieve saved bin
      uses: actions/download-artifact@v7
      with:
        name: cargo-green

    - name: Install saved bin
      shell: bash -eu {0}
      run: | # TODO: whence https://github.com/actions/download-artifact/issues/236
        chmod +x ./cargo-green
        { ! ./cargo-green --version ; } | grep cargo-green
        mv ./cargo-green ~/.cargo/bin/
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      name: Retrieve saved builder data
      uses: actions/download-artifact@v7
      with:
        name: builder-data
        path: /home/runner/builder-cache
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      run: |
        set -x
        sudo mkdir -p $(cargo green supergreen sync data 2>/dev/null)
        sudo mv -v /home/runner/builder-cache/* $(cargo green supergreen sync data 2>/dev/null)/
        sudo chown -R root:root $(cargo green supergreen sync data 2>/dev/null)
    - uses: actions/checkout@v6
    - run: docker info
    - run: docker buildx version
    - run: docker buildx build --help
    - run: podman version || true
    - run: cargo -Vv

    - name: Prepare local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # https://github.com/fenollp/supergreen/actions/caches
        mkdir -p /tmp/.local-registry
        mkdir -p /tmp/.local-registry-new
    - name: ðŸ”µ Restore local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      uses: actions/cache/restore@v5
      with:
        path: /tmp/.local-registry
        # github.run_id: https://github.com/actions/toolkit/issues/658#issuecomment-2640690759
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}
        restore-keys: |
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-
          localprivatereg-${{ runner.os }}-
          localprivatereg-

    - name: Pull regist3 image
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        false \
        || docker build --tag regist3 - <<<'FROM docker.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM mirror.gcr.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM public.ecr.aws/docker/registry:3' \
        || exit 1
    - name: Start "cache from" image registry
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' }}
      run: docker run --name=reg-from --rm --detach -p 12345:5000 --user $(id -u):$(id -g) -v     /tmp/.local-registry:/var/lib/registry regist3
    - name: Start "cache to" image registry
      if: ${{ env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: docker run --name=reg-to   --rm --detach -p 23456:5000 --user $(id -u):$(id -g) -v /tmp/.local-registry-new:/var/lib/registry regist3

    - name: ðŸ”µ Envs
      run: ~/.cargo/bin/cargo-green green supergreen env
    - if: ${{ matrix.toolchain != '1.91.1' }}
      run: ~/.cargo/bin/cargo-green green supergreen env CARGOGREEN_BASE_IMAGE | grep '${{ matrix.toolchain }}'
    - run: ~/.cargo/bin/cargo-green green supergreen builder
    - name: ðŸ”µ Envs again
      run: ~/.cargo/bin/cargo-green green supergreen env

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose
    - name: ðŸ”µ cargo install
      id: cargo-install
      continue-on-error: true
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --locked --force cargo-nextest@0.9.114  |& tee _
    - name: ðŸ”µ cargo install jobs=1
      #if: ${{ job.steps.cargo-install.outcome == 'failure' }} this actually hides failure of cargo-install step
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --jobs=1 --locked --force cargo-nextest@0.9.114  |& tee _
    - if: ${{ always() && matrix.toolchain != '1.91.1' }}
      uses: actions/upload-artifact@v7
      name: Upload recipe
      with:
        name: cargo-nextest@0.9.114.Dockerfile
        path: ${{ env.CARGOGREEN_FINAL_PATH }}
        if-no-files-found: error
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH
    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

    - name: ðŸ”µ Ensure running the same command twice without modifications...
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --locked --force cargo-nextest@0.9.114  |& tee _
    - name: ...doesn't recompile anything
      run: |
        err=0
        grep Finished  _
        grep Finished  _ | grep -E [012]...s || ((err+=1))
        grep Dirty     _                     && ((err+=2))
        grep Compiling _                     && ((err+=4))
        exit $err
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH

    - name: ðŸ”µ Compare old/new local private registry image digests
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        diff --width=150 -y \
          <(find /tmp/.local-registry/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) \
          <(find /tmp/.local-registry-new/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) || true
        du -sh /tmp/.local-registry /tmp/.local-registry-new || true
    - name: Local private registry cache dance
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # [ci: caches keep growing](https://github.com/moby/buildkit/issues/1850)
        docker stop --timeout 10 reg-from reg-to
        rm -rf /tmp/.local-registry
        mv /tmp/.local-registry-new /tmp/.local-registry
    - name: Save local private registry cache
      uses: actions/cache/save@v5
      if: ${{ false }} # TODO: drop when digests are stable
      with:
        path: /tmp/.local-registry
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

  cross_0-2-5:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -euo pipefail {0}
    continue-on-error: ${{ matrix.toolchain != '1.91.1' }}
    strategy:
      matrix:
        toolchain:
        - 1.91.1
        - 1.90.0
        exclude:
        - toolchain: ${{ github.ref != 'refs/heads/main' && '1.91.1' }}
    env:
      CARGO_TARGET_DIR: /tmp/clis-cross_0-2-5
    # CARGOGREEN_CACHE_FROM_IMAGES: docker-image://localhost:12345/${{ github.repository }}
    # CARGOGREEN_CACHE_TO_IMAGES: docker-image://localhost:23456/${{ github.repository }}
      CARGOGREEN_FINAL_PATH: recipes/cross@0.2.5.Dockerfile
      CARGOGREEN_EXPERIMENT: finalpathnonprimary # dumps on each build call
      CARGOGREEN_LOG: trace
      CARGOGREEN_LOG_PATH: logs.txt

    needs: bin
    steps:
    - uses: docker/login-action@v3
      if: ${{ ! startsWith(github.ref, 'refs/heads/dependabot/') }}
      with:
        username: ${{ vars.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: ${{ matrix.toolchain }}
        rustflags: ''
        cache-on-failure: true


    - name: Retrieve saved bin
      uses: actions/download-artifact@v7
      with:
        name: cargo-green

    - name: Install saved bin
      shell: bash -eu {0}
      run: | # TODO: whence https://github.com/actions/download-artifact/issues/236
        chmod +x ./cargo-green
        { ! ./cargo-green --version ; } | grep cargo-green
        mv ./cargo-green ~/.cargo/bin/
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      name: Retrieve saved builder data
      uses: actions/download-artifact@v7
      with:
        name: builder-data
        path: /home/runner/builder-cache
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      run: |
        set -x
        sudo mkdir -p $(cargo green supergreen sync data 2>/dev/null)
        sudo mv -v /home/runner/builder-cache/* $(cargo green supergreen sync data 2>/dev/null)/
        sudo chown -R root:root $(cargo green supergreen sync data 2>/dev/null)
    - uses: actions/checkout@v6
    - run: docker info
    - run: docker buildx version
    - run: docker buildx build --help
    - run: podman version || true
    - run: cargo -Vv

    - name: Prepare local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # https://github.com/fenollp/supergreen/actions/caches
        mkdir -p /tmp/.local-registry
        mkdir -p /tmp/.local-registry-new
    - name: ðŸ”µ Restore local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      uses: actions/cache/restore@v5
      with:
        path: /tmp/.local-registry
        # github.run_id: https://github.com/actions/toolkit/issues/658#issuecomment-2640690759
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}
        restore-keys: |
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-
          localprivatereg-${{ runner.os }}-
          localprivatereg-

    - name: Pull regist3 image
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        false \
        || docker build --tag regist3 - <<<'FROM docker.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM mirror.gcr.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM public.ecr.aws/docker/registry:3' \
        || exit 1
    - name: Start "cache from" image registry
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' }}
      run: docker run --name=reg-from --rm --detach -p 12345:5000 --user $(id -u):$(id -g) -v     /tmp/.local-registry:/var/lib/registry regist3
    - name: Start "cache to" image registry
      if: ${{ env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: docker run --name=reg-to   --rm --detach -p 23456:5000 --user $(id -u):$(id -g) -v /tmp/.local-registry-new:/var/lib/registry regist3

    - name: ðŸ”µ Envs
      run: ~/.cargo/bin/cargo-green green supergreen env
    - if: ${{ matrix.toolchain != '1.91.1' }}
      run: ~/.cargo/bin/cargo-green green supergreen env CARGOGREEN_BASE_IMAGE | grep '${{ matrix.toolchain }}'
    - run: ~/.cargo/bin/cargo-green green supergreen builder
    - name: ðŸ”µ Envs again
      run: ~/.cargo/bin/cargo-green green supergreen env

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose
    - name: ðŸ”µ cargo install
      id: cargo-install
      continue-on-error: true
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --locked --force cross@0.2.5 --git https://github.com/cross-rs/cross.git --rev=49cd054de9b832dfc11a4895c72b0aef533b5c6a cross |& tee _
    - name: ðŸ”µ cargo install jobs=1
      #if: ${{ job.steps.cargo-install.outcome == 'failure' }} this actually hides failure of cargo-install step
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --jobs=1 --locked --force cross@0.2.5 --git https://github.com/cross-rs/cross.git --rev=49cd054de9b832dfc11a4895c72b0aef533b5c6a cross |& tee _
    - if: ${{ always() && matrix.toolchain != '1.91.1' }}
      uses: actions/upload-artifact@v7
      name: Upload recipe
      with:
        name: cross@0.2.5.Dockerfile
        path: ${{ env.CARGOGREEN_FINAL_PATH }}
        if-no-files-found: error
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH
    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

    - name: ðŸ”µ Ensure running the same command twice without modifications...
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --locked --force cross@0.2.5 --git https://github.com/cross-rs/cross.git --rev=49cd054de9b832dfc11a4895c72b0aef533b5c6a cross |& tee _
    - name: ...doesn't recompile anything
      run: |
        err=0
        grep Finished  _
        grep Finished  _ | grep -E [012]...s || ((err+=1))
        grep Dirty     _                     && ((err+=2))
        grep Compiling _                     && ((err+=4))
        exit $err
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH

    - name: ðŸ”µ Compare old/new local private registry image digests
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        diff --width=150 -y \
          <(find /tmp/.local-registry/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) \
          <(find /tmp/.local-registry-new/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) || true
        du -sh /tmp/.local-registry /tmp/.local-registry-new || true
    - name: Local private registry cache dance
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # [ci: caches keep growing](https://github.com/moby/buildkit/issues/1850)
        docker stop --timeout 10 reg-from reg-to
        rm -rf /tmp/.local-registry
        mv /tmp/.local-registry-new /tmp/.local-registry
    - name: Save local private registry cache
      uses: actions/cache/save@v5
      if: ${{ false }} # TODO: drop when digests are stable
      with:
        path: /tmp/.local-registry
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

  dbcc_2-2-1:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -euo pipefail {0}
    continue-on-error: ${{ matrix.toolchain != '1.91.1' }}
    strategy:
      matrix:
        toolchain:
        - 1.91.1
        - 1.90.0
        exclude:
        - toolchain: ${{ github.ref != 'refs/heads/main' && '1.91.1' }}
    env:
      CARGO_TARGET_DIR: /tmp/clis-dbcc_2-2-1
    # CARGOGREEN_CACHE_FROM_IMAGES: docker-image://localhost:12345/${{ github.repository }}
    # CARGOGREEN_CACHE_TO_IMAGES: docker-image://localhost:23456/${{ github.repository }}
      CARGOGREEN_FINAL_PATH: recipes/dbcc@2.2.1.Dockerfile
      CARGOGREEN_EXPERIMENT: finalpathnonprimary # dumps on each build call
      CARGOGREEN_LOG: trace
      CARGOGREEN_LOG_PATH: logs.txt

    needs: bin
    steps:
    - uses: docker/login-action@v3
      if: ${{ ! startsWith(github.ref, 'refs/heads/dependabot/') }}
      with:
        username: ${{ vars.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: ${{ matrix.toolchain }}
        rustflags: ''
        cache-on-failure: true


    - name: Retrieve saved bin
      uses: actions/download-artifact@v7
      with:
        name: cargo-green

    - name: Install saved bin
      shell: bash -eu {0}
      run: | # TODO: whence https://github.com/actions/download-artifact/issues/236
        chmod +x ./cargo-green
        { ! ./cargo-green --version ; } | grep cargo-green
        mv ./cargo-green ~/.cargo/bin/
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      name: Retrieve saved builder data
      uses: actions/download-artifact@v7
      with:
        name: builder-data
        path: /home/runner/builder-cache
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      run: |
        set -x
        sudo mkdir -p $(cargo green supergreen sync data 2>/dev/null)
        sudo mv -v /home/runner/builder-cache/* $(cargo green supergreen sync data 2>/dev/null)/
        sudo chown -R root:root $(cargo green supergreen sync data 2>/dev/null)
    - uses: actions/checkout@v6
    - run: docker info
    - run: docker buildx version
    - run: docker buildx build --help
    - run: podman version || true
    - run: cargo -Vv

    - name: Prepare local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # https://github.com/fenollp/supergreen/actions/caches
        mkdir -p /tmp/.local-registry
        mkdir -p /tmp/.local-registry-new
    - name: ðŸ”µ Restore local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      uses: actions/cache/restore@v5
      with:
        path: /tmp/.local-registry
        # github.run_id: https://github.com/actions/toolkit/issues/658#issuecomment-2640690759
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}
        restore-keys: |
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-
          localprivatereg-${{ runner.os }}-
          localprivatereg-

    - name: Pull regist3 image
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        false \
        || docker build --tag regist3 - <<<'FROM docker.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM mirror.gcr.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM public.ecr.aws/docker/registry:3' \
        || exit 1
    - name: Start "cache from" image registry
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' }}
      run: docker run --name=reg-from --rm --detach -p 12345:5000 --user $(id -u):$(id -g) -v     /tmp/.local-registry:/var/lib/registry regist3
    - name: Start "cache to" image registry
      if: ${{ env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: docker run --name=reg-to   --rm --detach -p 23456:5000 --user $(id -u):$(id -g) -v /tmp/.local-registry-new:/var/lib/registry regist3

    - name: ðŸ”µ Envs
      run: ~/.cargo/bin/cargo-green green supergreen env
    - if: ${{ matrix.toolchain != '1.91.1' }}
      run: ~/.cargo/bin/cargo-green green supergreen env CARGOGREEN_BASE_IMAGE | grep '${{ matrix.toolchain }}'
    - run: ~/.cargo/bin/cargo-green green supergreen builder
    - name: ðŸ”µ Envs again
      run: ~/.cargo/bin/cargo-green green supergreen env

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose
    - name: ðŸ”µ cargo install
      id: cargo-install
      continue-on-error: true
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --locked --force dbcc@2.2.1  |& tee _
    - name: ðŸ”µ cargo install jobs=1
      #if: ${{ job.steps.cargo-install.outcome == 'failure' }} this actually hides failure of cargo-install step
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --jobs=1 --locked --force dbcc@2.2.1  |& tee _
    - if: ${{ always() && matrix.toolchain != '1.91.1' }}
      uses: actions/upload-artifact@v7
      name: Upload recipe
      with:
        name: dbcc@2.2.1.Dockerfile
        path: ${{ env.CARGOGREEN_FINAL_PATH }}
        if-no-files-found: error
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH
    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

    - name: ðŸ”µ Ensure running the same command twice without modifications...
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --locked --force dbcc@2.2.1  |& tee _
    - name: ...doesn't recompile anything
      run: |
        err=0
        grep Finished  _
        grep Finished  _ | grep -E [012]...s || ((err+=1))
        grep Dirty     _                     && ((err+=2))
        grep Compiling _                     && ((err+=4))
        exit $err
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH

    - name: ðŸ”µ Compare old/new local private registry image digests
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        diff --width=150 -y \
          <(find /tmp/.local-registry/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) \
          <(find /tmp/.local-registry-new/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) || true
        du -sh /tmp/.local-registry /tmp/.local-registry-new || true
    - name: Local private registry cache dance
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # [ci: caches keep growing](https://github.com/moby/buildkit/issues/1850)
        docker stop --timeout 10 reg-from reg-to
        rm -rf /tmp/.local-registry
        mv /tmp/.local-registry-new /tmp/.local-registry
    - name: Save local private registry cache
      uses: actions/cache/save@v5
      if: ${{ false }} # TODO: drop when digests are stable
      with:
        path: /tmp/.local-registry
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

  diesel_cli_2-3-4:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -euo pipefail {0}
    continue-on-error: ${{ matrix.toolchain != '1.91.1' }}
    strategy:
      matrix:
        toolchain:
        - 1.91.1
        - 1.90.0
        exclude:
        - toolchain: ${{ github.ref != 'refs/heads/main' && '1.91.1' }}
    env:
      CARGO_TARGET_DIR: /tmp/clis-diesel_cli_2-3-4
    # CARGOGREEN_CACHE_FROM_IMAGES: docker-image://localhost:12345/${{ github.repository }}
    # CARGOGREEN_CACHE_TO_IMAGES: docker-image://localhost:23456/${{ github.repository }}
      CARGOGREEN_FINAL_PATH: recipes/diesel_cli@2.3.4.Dockerfile
      CARGOGREEN_EXPERIMENT: finalpathnonprimary # dumps on each build call
      CARGOGREEN_LOG: trace
      CARGOGREEN_LOG_PATH: logs.txt

    needs: bin
    steps:
    - uses: docker/login-action@v3
      if: ${{ ! startsWith(github.ref, 'refs/heads/dependabot/') }}
      with:
        username: ${{ vars.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: ${{ matrix.toolchain }}
        rustflags: ''
        cache-on-failure: true


    - name: Retrieve saved bin
      uses: actions/download-artifact@v7
      with:
        name: cargo-green

    - name: Install saved bin
      shell: bash -eu {0}
      run: | # TODO: whence https://github.com/actions/download-artifact/issues/236
        chmod +x ./cargo-green
        { ! ./cargo-green --version ; } | grep cargo-green
        mv ./cargo-green ~/.cargo/bin/
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      name: Retrieve saved builder data
      uses: actions/download-artifact@v7
      with:
        name: builder-data
        path: /home/runner/builder-cache
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      run: |
        set -x
        sudo mkdir -p $(cargo green supergreen sync data 2>/dev/null)
        sudo mv -v /home/runner/builder-cache/* $(cargo green supergreen sync data 2>/dev/null)/
        sudo chown -R root:root $(cargo green supergreen sync data 2>/dev/null)
    - uses: actions/checkout@v6
    - run: docker info
    - run: docker buildx version
    - run: docker buildx build --help
    - run: podman version || true
    - run: cargo -Vv

    - name: Prepare local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # https://github.com/fenollp/supergreen/actions/caches
        mkdir -p /tmp/.local-registry
        mkdir -p /tmp/.local-registry-new
    - name: ðŸ”µ Restore local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      uses: actions/cache/restore@v5
      with:
        path: /tmp/.local-registry
        # github.run_id: https://github.com/actions/toolkit/issues/658#issuecomment-2640690759
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}
        restore-keys: |
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-
          localprivatereg-${{ runner.os }}-
          localprivatereg-

    - name: Pull regist3 image
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        false \
        || docker build --tag regist3 - <<<'FROM docker.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM mirror.gcr.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM public.ecr.aws/docker/registry:3' \
        || exit 1
    - name: Start "cache from" image registry
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' }}
      run: docker run --name=reg-from --rm --detach -p 12345:5000 --user $(id -u):$(id -g) -v     /tmp/.local-registry:/var/lib/registry regist3
    - name: Start "cache to" image registry
      if: ${{ env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: docker run --name=reg-to   --rm --detach -p 23456:5000 --user $(id -u):$(id -g) -v /tmp/.local-registry-new:/var/lib/registry regist3

    - name: ðŸ”µ Envs
      run: ~/.cargo/bin/cargo-green green supergreen env
    - if: ${{ matrix.toolchain != '1.91.1' }}
      run: ~/.cargo/bin/cargo-green green supergreen env CARGOGREEN_BASE_IMAGE | grep '${{ matrix.toolchain }}'
    - run: ~/.cargo/bin/cargo-green green supergreen builder
    - name: ðŸ”µ Envs again
      run: ~/.cargo/bin/cargo-green green supergreen env

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose
    - name: ðŸ”µ cargo install
      id: cargo-install
      continue-on-error: true
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env CARGOGREEN_ADD_APT=libpq-dev \
          cargo green -vv install --locked --force diesel_cli@2.3.4 --no-default-features --features=postgres |& tee _
    - name: ðŸ”µ cargo install jobs=1
      #if: ${{ job.steps.cargo-install.outcome == 'failure' }} this actually hides failure of cargo-install step
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env CARGOGREEN_ADD_APT=libpq-dev \
          cargo green -vv install --jobs=1 --locked --force diesel_cli@2.3.4 --no-default-features --features=postgres |& tee _
    - if: ${{ always() && matrix.toolchain != '1.91.1' }}
      uses: actions/upload-artifact@v7
      name: Upload recipe
      with:
        name: diesel_cli@2.3.4.Dockerfile
        path: ${{ env.CARGOGREEN_FINAL_PATH }}
        if-no-files-found: error
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH
    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

    - name: ðŸ”µ Ensure running the same command twice without modifications...
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env CARGOGREEN_ADD_APT=libpq-dev \
          cargo green -vv install --locked --force diesel_cli@2.3.4 --no-default-features --features=postgres |& tee _
    - name: ...doesn't recompile anything
      run: |
        err=0
        grep Finished  _
        grep Finished  _ | grep -E [012]...s || ((err+=1))
        grep Dirty     _                     && ((err+=2))
        grep Compiling _                     && ((err+=4))
        exit $err
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH

    - name: ðŸ”µ Compare old/new local private registry image digests
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        diff --width=150 -y \
          <(find /tmp/.local-registry/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) \
          <(find /tmp/.local-registry-new/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) || true
        du -sh /tmp/.local-registry /tmp/.local-registry-new || true
    - name: Local private registry cache dance
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # [ci: caches keep growing](https://github.com/moby/buildkit/issues/1850)
        docker stop --timeout 10 reg-from reg-to
        rm -rf /tmp/.local-registry
        mv /tmp/.local-registry-new /tmp/.local-registry
    - name: Save local private registry cache
      uses: actions/cache/save@v5
      if: ${{ false }} # TODO: drop when digests are stable
      with:
        path: /tmp/.local-registry
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

  hickory-dns_0-26-0-alpha-1:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -euo pipefail {0}
    continue-on-error: ${{ matrix.toolchain != '1.91.1' }}
    strategy:
      matrix:
        toolchain:
        - 1.91.1
        - 1.90.0
        exclude:
        - toolchain: ${{ github.ref != 'refs/heads/main' && '1.91.1' }}
    env:
      CARGO_TARGET_DIR: /tmp/clis-hickory-dns_0-26-0-alpha-1
    # CARGOGREEN_CACHE_FROM_IMAGES: docker-image://localhost:12345/${{ github.repository }}
    # CARGOGREEN_CACHE_TO_IMAGES: docker-image://localhost:23456/${{ github.repository }}
      CARGOGREEN_FINAL_PATH: recipes/hickory-dns@0.26.0-alpha.1.Dockerfile
      CARGOGREEN_EXPERIMENT: finalpathnonprimary # dumps on each build call
      CARGOGREEN_LOG: trace
      CARGOGREEN_LOG_PATH: logs.txt

    needs: bin
    steps:
    - uses: docker/login-action@v3
      if: ${{ ! startsWith(github.ref, 'refs/heads/dependabot/') }}
      with:
        username: ${{ vars.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: ${{ matrix.toolchain }}
        rustflags: ''
        cache-on-failure: true


    - name: Retrieve saved bin
      uses: actions/download-artifact@v7
      with:
        name: cargo-green

    - name: Install saved bin
      shell: bash -eu {0}
      run: | # TODO: whence https://github.com/actions/download-artifact/issues/236
        chmod +x ./cargo-green
        { ! ./cargo-green --version ; } | grep cargo-green
        mv ./cargo-green ~/.cargo/bin/
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      name: Retrieve saved builder data
      uses: actions/download-artifact@v7
      with:
        name: builder-data
        path: /home/runner/builder-cache
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      run: |
        set -x
        sudo mkdir -p $(cargo green supergreen sync data 2>/dev/null)
        sudo mv -v /home/runner/builder-cache/* $(cargo green supergreen sync data 2>/dev/null)/
        sudo chown -R root:root $(cargo green supergreen sync data 2>/dev/null)
    - uses: actions/checkout@v6
    - run: docker info
    - run: docker buildx version
    - run: docker buildx build --help
    - run: podman version || true
    - run: cargo -Vv

    - name: Prepare local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # https://github.com/fenollp/supergreen/actions/caches
        mkdir -p /tmp/.local-registry
        mkdir -p /tmp/.local-registry-new
    - name: ðŸ”µ Restore local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      uses: actions/cache/restore@v5
      with:
        path: /tmp/.local-registry
        # github.run_id: https://github.com/actions/toolkit/issues/658#issuecomment-2640690759
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}
        restore-keys: |
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-
          localprivatereg-${{ runner.os }}-
          localprivatereg-

    - name: Pull regist3 image
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        false \
        || docker build --tag regist3 - <<<'FROM docker.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM mirror.gcr.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM public.ecr.aws/docker/registry:3' \
        || exit 1
    - name: Start "cache from" image registry
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' }}
      run: docker run --name=reg-from --rm --detach -p 12345:5000 --user $(id -u):$(id -g) -v     /tmp/.local-registry:/var/lib/registry regist3
    - name: Start "cache to" image registry
      if: ${{ env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: docker run --name=reg-to   --rm --detach -p 23456:5000 --user $(id -u):$(id -g) -v /tmp/.local-registry-new:/var/lib/registry regist3

    - name: ðŸ”µ Envs
      run: ~/.cargo/bin/cargo-green green supergreen env
    - if: ${{ matrix.toolchain != '1.91.1' }}
      run: ~/.cargo/bin/cargo-green green supergreen env CARGOGREEN_BASE_IMAGE | grep '${{ matrix.toolchain }}'
    - run: ~/.cargo/bin/cargo-green green supergreen builder
    - name: ðŸ”µ Envs again
      run: ~/.cargo/bin/cargo-green green supergreen env

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose
    - name: ðŸ”µ cargo install
      id: cargo-install
      continue-on-error: true
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --locked --force hickory-dns@0.26.0-alpha.1  |& tee _
    - name: ðŸ”µ cargo install jobs=1
      #if: ${{ job.steps.cargo-install.outcome == 'failure' }} this actually hides failure of cargo-install step
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --jobs=1 --locked --force hickory-dns@0.26.0-alpha.1  |& tee _
    - if: ${{ always() && matrix.toolchain != '1.91.1' }}
      uses: actions/upload-artifact@v7
      name: Upload recipe
      with:
        name: hickory-dns@0.26.0-alpha.1.Dockerfile
        path: ${{ env.CARGOGREEN_FINAL_PATH }}
        if-no-files-found: error
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH
    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

    - name: ðŸ”µ Ensure running the same command twice without modifications...
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --locked --force hickory-dns@0.26.0-alpha.1  |& tee _
    - name: ...doesn't recompile anything
      run: |
        err=0
        grep Finished  _
        grep Finished  _ | grep -E [012]...s || ((err+=1))
        grep Dirty     _                     && ((err+=2))
        grep Compiling _                     && ((err+=4))
        exit $err
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH

    - name: ðŸ”µ Compare old/new local private registry image digests
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        diff --width=150 -y \
          <(find /tmp/.local-registry/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) \
          <(find /tmp/.local-registry-new/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) || true
        du -sh /tmp/.local-registry /tmp/.local-registry-new || true
    - name: Local private registry cache dance
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # [ci: caches keep growing](https://github.com/moby/buildkit/issues/1850)
        docker stop --timeout 10 reg-from reg-to
        rm -rf /tmp/.local-registry
        mv /tmp/.local-registry-new /tmp/.local-registry
    - name: Save local private registry cache
      uses: actions/cache/save@v5
      if: ${{ false }} # TODO: drop when digests are stable
      with:
        path: /tmp/.local-registry
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

  mussh_3-1-3:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -euo pipefail {0}
    continue-on-error: ${{ matrix.toolchain != '1.91.1' }}
    strategy:
      matrix:
        toolchain:
        - 1.91.1
        - 1.90.0
        exclude:
        - toolchain: ${{ github.ref != 'refs/heads/main' && '1.91.1' }}
    env:
      CARGO_TARGET_DIR: /tmp/clis-mussh_3-1-3
    # CARGOGREEN_CACHE_FROM_IMAGES: docker-image://localhost:12345/${{ github.repository }}
    # CARGOGREEN_CACHE_TO_IMAGES: docker-image://localhost:23456/${{ github.repository }}
      CARGOGREEN_FINAL_PATH: recipes/mussh@3.1.3.Dockerfile
      CARGOGREEN_EXPERIMENT: finalpathnonprimary # dumps on each build call
      CARGOGREEN_LOG: trace
      CARGOGREEN_LOG_PATH: logs.txt

    needs: bin
    steps:
    - uses: docker/login-action@v3
      if: ${{ ! startsWith(github.ref, 'refs/heads/dependabot/') }}
      with:
        username: ${{ vars.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: ${{ matrix.toolchain }}
        rustflags: ''
        cache-on-failure: true


    - name: Retrieve saved bin
      uses: actions/download-artifact@v7
      with:
        name: cargo-green

    - name: Install saved bin
      shell: bash -eu {0}
      run: | # TODO: whence https://github.com/actions/download-artifact/issues/236
        chmod +x ./cargo-green
        { ! ./cargo-green --version ; } | grep cargo-green
        mv ./cargo-green ~/.cargo/bin/
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      name: Retrieve saved builder data
      uses: actions/download-artifact@v7
      with:
        name: builder-data
        path: /home/runner/builder-cache
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      run: |
        set -x
        sudo mkdir -p $(cargo green supergreen sync data 2>/dev/null)
        sudo mv -v /home/runner/builder-cache/* $(cargo green supergreen sync data 2>/dev/null)/
        sudo chown -R root:root $(cargo green supergreen sync data 2>/dev/null)
    - uses: actions/checkout@v6
    - run: docker info
    - run: docker buildx version
    - run: docker buildx build --help
    - run: podman version || true
    - run: cargo -Vv

    - name: Prepare local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # https://github.com/fenollp/supergreen/actions/caches
        mkdir -p /tmp/.local-registry
        mkdir -p /tmp/.local-registry-new
    - name: ðŸ”µ Restore local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      uses: actions/cache/restore@v5
      with:
        path: /tmp/.local-registry
        # github.run_id: https://github.com/actions/toolkit/issues/658#issuecomment-2640690759
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}
        restore-keys: |
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-
          localprivatereg-${{ runner.os }}-
          localprivatereg-

    - name: Pull regist3 image
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        false \
        || docker build --tag regist3 - <<<'FROM docker.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM mirror.gcr.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM public.ecr.aws/docker/registry:3' \
        || exit 1
    - name: Start "cache from" image registry
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' }}
      run: docker run --name=reg-from --rm --detach -p 12345:5000 --user $(id -u):$(id -g) -v     /tmp/.local-registry:/var/lib/registry regist3
    - name: Start "cache to" image registry
      if: ${{ env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: docker run --name=reg-to   --rm --detach -p 23456:5000 --user $(id -u):$(id -g) -v /tmp/.local-registry-new:/var/lib/registry regist3

    - name: ðŸ”µ Envs
      run: ~/.cargo/bin/cargo-green green supergreen env
    - if: ${{ matrix.toolchain != '1.91.1' }}
      run: ~/.cargo/bin/cargo-green green supergreen env CARGOGREEN_BASE_IMAGE | grep '${{ matrix.toolchain }}'
    - run: ~/.cargo/bin/cargo-green green supergreen builder
    - name: ðŸ”µ Envs again
      run: ~/.cargo/bin/cargo-green green supergreen env

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose
    - name: ðŸ”µ cargo install
      id: cargo-install
      continue-on-error: true
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env CARGOGREEN_ADD_APT=libsqlite3-dev,libssl-dev,pkg-config,zlib1g-dev \
          cargo green -vv install --locked --force mussh@3.1.3  |& tee _
    - name: ðŸ”µ cargo install jobs=1
      #if: ${{ job.steps.cargo-install.outcome == 'failure' }} this actually hides failure of cargo-install step
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env CARGOGREEN_ADD_APT=libsqlite3-dev,libssl-dev,pkg-config,zlib1g-dev \
          cargo green -vv install --jobs=1 --locked --force mussh@3.1.3  |& tee _
    - if: ${{ always() && matrix.toolchain != '1.91.1' }}
      uses: actions/upload-artifact@v7
      name: Upload recipe
      with:
        name: mussh@3.1.3.Dockerfile
        path: ${{ env.CARGOGREEN_FINAL_PATH }}
        if-no-files-found: error
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH
    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

    - name: ðŸ”µ Ensure running the same command twice without modifications...
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env CARGOGREEN_ADD_APT=libsqlite3-dev,libssl-dev,pkg-config,zlib1g-dev \
          cargo green -vv install --locked --force mussh@3.1.3  |& tee _
    - name: ...doesn't recompile anything
      run: |
        err=0
        grep Finished  _
        grep Finished  _ | grep -E [012]...s || ((err+=1))
        grep Dirty     _                     && ((err+=2))
        grep Compiling _                     && ((err+=4))
        exit $err
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH

    - name: ðŸ”µ Compare old/new local private registry image digests
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        diff --width=150 -y \
          <(find /tmp/.local-registry/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) \
          <(find /tmp/.local-registry-new/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) || true
        du -sh /tmp/.local-registry /tmp/.local-registry-new || true
    - name: Local private registry cache dance
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # [ci: caches keep growing](https://github.com/moby/buildkit/issues/1850)
        docker stop --timeout 10 reg-from reg-to
        rm -rf /tmp/.local-registry
        mv /tmp/.local-registry-new /tmp/.local-registry
    - name: Save local private registry cache
      uses: actions/cache/save@v5
      if: ${{ false }} # TODO: drop when digests are stable
      with:
        path: /tmp/.local-registry
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

  ntpd_1-7-0-alpha-20251003:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -euo pipefail {0}
    continue-on-error: ${{ matrix.toolchain != '1.91.1' }}
    strategy:
      matrix:
        toolchain:
        - 1.91.1
        - 1.90.0
        exclude:
        - toolchain: ${{ github.ref != 'refs/heads/main' && '1.91.1' }}
    env:
      CARGO_TARGET_DIR: /tmp/clis-ntpd_1-7-0-alpha-20251003
    # CARGOGREEN_CACHE_FROM_IMAGES: docker-image://localhost:12345/${{ github.repository }}
    # CARGOGREEN_CACHE_TO_IMAGES: docker-image://localhost:23456/${{ github.repository }}
      CARGOGREEN_FINAL_PATH: recipes/ntpd@1.7.0-alpha.20251003.Dockerfile
      CARGOGREEN_EXPERIMENT: finalpathnonprimary # dumps on each build call
      CARGOGREEN_LOG: trace
      CARGOGREEN_LOG_PATH: logs.txt
      NTPD_RS_GIT_REV: c7945250c378f65f65b2a75748132edf75063b3b
      NTPD_RS_GIT_DATE: 2025-05-09
    needs: bin
    steps:
    - uses: docker/login-action@v3
      if: ${{ ! startsWith(github.ref, 'refs/heads/dependabot/') }}
      with:
        username: ${{ vars.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: ${{ matrix.toolchain }}
        rustflags: ''
        cache-on-failure: true


    - name: Retrieve saved bin
      uses: actions/download-artifact@v7
      with:
        name: cargo-green

    - name: Install saved bin
      shell: bash -eu {0}
      run: | # TODO: whence https://github.com/actions/download-artifact/issues/236
        chmod +x ./cargo-green
        { ! ./cargo-green --version ; } | grep cargo-green
        mv ./cargo-green ~/.cargo/bin/
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      name: Retrieve saved builder data
      uses: actions/download-artifact@v7
      with:
        name: builder-data
        path: /home/runner/builder-cache
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      run: |
        set -x
        sudo mkdir -p $(cargo green supergreen sync data 2>/dev/null)
        sudo mv -v /home/runner/builder-cache/* $(cargo green supergreen sync data 2>/dev/null)/
        sudo chown -R root:root $(cargo green supergreen sync data 2>/dev/null)
    - uses: actions/checkout@v6
    - run: docker info
    - run: docker buildx version
    - run: docker buildx build --help
    - run: podman version || true
    - run: cargo -Vv

    - name: Prepare local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # https://github.com/fenollp/supergreen/actions/caches
        mkdir -p /tmp/.local-registry
        mkdir -p /tmp/.local-registry-new
    - name: ðŸ”µ Restore local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      uses: actions/cache/restore@v5
      with:
        path: /tmp/.local-registry
        # github.run_id: https://github.com/actions/toolkit/issues/658#issuecomment-2640690759
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}
        restore-keys: |
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-
          localprivatereg-${{ runner.os }}-
          localprivatereg-

    - name: Pull regist3 image
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        false \
        || docker build --tag regist3 - <<<'FROM docker.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM mirror.gcr.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM public.ecr.aws/docker/registry:3' \
        || exit 1
    - name: Start "cache from" image registry
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' }}
      run: docker run --name=reg-from --rm --detach -p 12345:5000 --user $(id -u):$(id -g) -v     /tmp/.local-registry:/var/lib/registry regist3
    - name: Start "cache to" image registry
      if: ${{ env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: docker run --name=reg-to   --rm --detach -p 23456:5000 --user $(id -u):$(id -g) -v /tmp/.local-registry-new:/var/lib/registry regist3

    - name: ðŸ”µ Envs
      run: ~/.cargo/bin/cargo-green green supergreen env
    - if: ${{ matrix.toolchain != '1.91.1' }}
      run: ~/.cargo/bin/cargo-green green supergreen env CARGOGREEN_BASE_IMAGE | grep '${{ matrix.toolchain }}'
    - run: ~/.cargo/bin/cargo-green green supergreen builder
    - name: ðŸ”µ Envs again
      run: ~/.cargo/bin/cargo-green green supergreen env

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose
    - name: ðŸ”µ cargo install
      id: cargo-install
      continue-on-error: true
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --locked --force ntpd@1.7.0-alpha.20251003  |& tee _
    - name: ðŸ”µ cargo install jobs=1
      #if: ${{ job.steps.cargo-install.outcome == 'failure' }} this actually hides failure of cargo-install step
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --jobs=1 --locked --force ntpd@1.7.0-alpha.20251003  |& tee _
    - if: ${{ always() && matrix.toolchain != '1.91.1' }}
      uses: actions/upload-artifact@v7
      name: Upload recipe
      with:
        name: ntpd@1.7.0-alpha.20251003.Dockerfile
        path: ${{ env.CARGOGREEN_FINAL_PATH }}
        if-no-files-found: error
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH
    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

    - name: ðŸ”µ Ensure running the same command twice without modifications...
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --locked --force ntpd@1.7.0-alpha.20251003  |& tee _
    - name: ...doesn't recompile anything
      run: |
        err=0
        grep Finished  _
        grep Finished  _ | grep -E [012]...s || ((err+=1))
        grep Dirty     _                     && ((err+=2))
        grep Compiling _                     && ((err+=4))
        exit $err
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH

    - name: ðŸ”µ Compare old/new local private registry image digests
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        diff --width=150 -y \
          <(find /tmp/.local-registry/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) \
          <(find /tmp/.local-registry-new/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) || true
        du -sh /tmp/.local-registry /tmp/.local-registry-new || true
    - name: Local private registry cache dance
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # [ci: caches keep growing](https://github.com/moby/buildkit/issues/1850)
        docker stop --timeout 10 reg-from reg-to
        rm -rf /tmp/.local-registry
        mv /tmp/.local-registry-new /tmp/.local-registry
    - name: Save local private registry cache
      uses: actions/cache/save@v5
      if: ${{ false }} # TODO: drop when digests are stable
      with:
        path: /tmp/.local-registry
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

  qcow2-rs_0-1-6:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -euo pipefail {0}
    continue-on-error: ${{ matrix.toolchain != '1.91.1' }}
    strategy:
      matrix:
        toolchain:
        - 1.91.1
        - 1.90.0
        exclude:
        - toolchain: ${{ github.ref != 'refs/heads/main' && '1.91.1' }}
    env:
      CARGO_TARGET_DIR: /tmp/clis-qcow2-rs_0-1-6
    # CARGOGREEN_CACHE_FROM_IMAGES: docker-image://localhost:12345/${{ github.repository }}
    # CARGOGREEN_CACHE_TO_IMAGES: docker-image://localhost:23456/${{ github.repository }}
      CARGOGREEN_FINAL_PATH: recipes/qcow2-rs@0.1.6.Dockerfile
      CARGOGREEN_EXPERIMENT: finalpathnonprimary # dumps on each build call
      CARGOGREEN_LOG: trace
      CARGOGREEN_LOG_PATH: logs.txt

    needs: bin
    steps:
    - uses: docker/login-action@v3
      if: ${{ ! startsWith(github.ref, 'refs/heads/dependabot/') }}
      with:
        username: ${{ vars.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: ${{ matrix.toolchain }}
        rustflags: ''
        cache-on-failure: true


    - name: Retrieve saved bin
      uses: actions/download-artifact@v7
      with:
        name: cargo-green

    - name: Install saved bin
      shell: bash -eu {0}
      run: | # TODO: whence https://github.com/actions/download-artifact/issues/236
        chmod +x ./cargo-green
        { ! ./cargo-green --version ; } | grep cargo-green
        mv ./cargo-green ~/.cargo/bin/
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      name: Retrieve saved builder data
      uses: actions/download-artifact@v7
      with:
        name: builder-data
        path: /home/runner/builder-cache
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      run: |
        set -x
        sudo mkdir -p $(cargo green supergreen sync data 2>/dev/null)
        sudo mv -v /home/runner/builder-cache/* $(cargo green supergreen sync data 2>/dev/null)/
        sudo chown -R root:root $(cargo green supergreen sync data 2>/dev/null)
    - uses: actions/checkout@v6
    - run: docker info
    - run: docker buildx version
    - run: docker buildx build --help
    - run: podman version || true
    - run: cargo -Vv

    - name: Prepare local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # https://github.com/fenollp/supergreen/actions/caches
        mkdir -p /tmp/.local-registry
        mkdir -p /tmp/.local-registry-new
    - name: ðŸ”µ Restore local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      uses: actions/cache/restore@v5
      with:
        path: /tmp/.local-registry
        # github.run_id: https://github.com/actions/toolkit/issues/658#issuecomment-2640690759
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}
        restore-keys: |
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-
          localprivatereg-${{ runner.os }}-
          localprivatereg-

    - name: Pull regist3 image
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        false \
        || docker build --tag regist3 - <<<'FROM docker.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM mirror.gcr.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM public.ecr.aws/docker/registry:3' \
        || exit 1
    - name: Start "cache from" image registry
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' }}
      run: docker run --name=reg-from --rm --detach -p 12345:5000 --user $(id -u):$(id -g) -v     /tmp/.local-registry:/var/lib/registry regist3
    - name: Start "cache to" image registry
      if: ${{ env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: docker run --name=reg-to   --rm --detach -p 23456:5000 --user $(id -u):$(id -g) -v /tmp/.local-registry-new:/var/lib/registry regist3

    - name: ðŸ”µ Envs
      run: ~/.cargo/bin/cargo-green green supergreen env
    - if: ${{ matrix.toolchain != '1.91.1' }}
      run: ~/.cargo/bin/cargo-green green supergreen env CARGOGREEN_BASE_IMAGE | grep '${{ matrix.toolchain }}'
    - run: ~/.cargo/bin/cargo-green green supergreen builder
    - name: ðŸ”µ Envs again
      run: ~/.cargo/bin/cargo-green green supergreen env

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose
    - name: ðŸ”µ cargo install
      id: cargo-install
      continue-on-error: true
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --locked --force qcow2-rs@0.1.6  |& tee _
    - name: ðŸ”µ cargo install jobs=1
      #if: ${{ job.steps.cargo-install.outcome == 'failure' }} this actually hides failure of cargo-install step
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --jobs=1 --locked --force qcow2-rs@0.1.6  |& tee _
    - if: ${{ always() && matrix.toolchain != '1.91.1' }}
      uses: actions/upload-artifact@v7
      name: Upload recipe
      with:
        name: qcow2-rs@0.1.6.Dockerfile
        path: ${{ env.CARGOGREEN_FINAL_PATH }}
        if-no-files-found: error
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH
    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

    - name: ðŸ”µ Ensure running the same command twice without modifications...
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --locked --force qcow2-rs@0.1.6  |& tee _
    - name: ...doesn't recompile anything
      run: |
        err=0
        grep Finished  _
        grep Finished  _ | grep -E [012]...s || ((err+=1))
        grep Dirty     _                     && ((err+=2))
        grep Compiling _                     && ((err+=4))
        exit $err
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH

    - name: ðŸ”µ Compare old/new local private registry image digests
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        diff --width=150 -y \
          <(find /tmp/.local-registry/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) \
          <(find /tmp/.local-registry-new/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) || true
        du -sh /tmp/.local-registry /tmp/.local-registry-new || true
    - name: Local private registry cache dance
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # [ci: caches keep growing](https://github.com/moby/buildkit/issues/1850)
        docker stop --timeout 10 reg-from reg-to
        rm -rf /tmp/.local-registry
        mv /tmp/.local-registry-new /tmp/.local-registry
    - name: Save local private registry cache
      uses: actions/cache/save@v5
      if: ${{ false }} # TODO: drop when digests are stable
      with:
        path: /tmp/.local-registry
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

  ripgrep_15-1-0:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -euo pipefail {0}
    continue-on-error: ${{ matrix.toolchain != '1.91.1' }}
    strategy:
      matrix:
        toolchain:
        - 1.91.1
        - 1.90.0
        exclude:
        - toolchain: ${{ github.ref != 'refs/heads/main' && '1.91.1' }}
    env:
      CARGO_TARGET_DIR: /tmp/clis-ripgrep_15-1-0
    # CARGOGREEN_CACHE_FROM_IMAGES: docker-image://localhost:12345/${{ github.repository }}
    # CARGOGREEN_CACHE_TO_IMAGES: docker-image://localhost:23456/${{ github.repository }}
      CARGOGREEN_FINAL_PATH: recipes/ripgrep@15.1.0.Dockerfile
      CARGOGREEN_EXPERIMENT: finalpathnonprimary # dumps on each build call
      CARGOGREEN_LOG: trace
      CARGOGREEN_LOG_PATH: logs.txt

    needs: bin
    steps:
    - uses: docker/login-action@v3
      if: ${{ ! startsWith(github.ref, 'refs/heads/dependabot/') }}
      with:
        username: ${{ vars.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: ${{ matrix.toolchain }}
        rustflags: ''
        cache-on-failure: true


    - name: Retrieve saved bin
      uses: actions/download-artifact@v7
      with:
        name: cargo-green

    - name: Install saved bin
      shell: bash -eu {0}
      run: | # TODO: whence https://github.com/actions/download-artifact/issues/236
        chmod +x ./cargo-green
        { ! ./cargo-green --version ; } | grep cargo-green
        mv ./cargo-green ~/.cargo/bin/
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      name: Retrieve saved builder data
      uses: actions/download-artifact@v7
      with:
        name: builder-data
        path: /home/runner/builder-cache
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      run: |
        set -x
        sudo mkdir -p $(cargo green supergreen sync data 2>/dev/null)
        sudo mv -v /home/runner/builder-cache/* $(cargo green supergreen sync data 2>/dev/null)/
        sudo chown -R root:root $(cargo green supergreen sync data 2>/dev/null)
    - uses: actions/checkout@v6
    - run: docker info
    - run: docker buildx version
    - run: docker buildx build --help
    - run: podman version || true
    - run: cargo -Vv

    - name: Prepare local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # https://github.com/fenollp/supergreen/actions/caches
        mkdir -p /tmp/.local-registry
        mkdir -p /tmp/.local-registry-new
    - name: ðŸ”µ Restore local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      uses: actions/cache/restore@v5
      with:
        path: /tmp/.local-registry
        # github.run_id: https://github.com/actions/toolkit/issues/658#issuecomment-2640690759
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}
        restore-keys: |
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-
          localprivatereg-${{ runner.os }}-
          localprivatereg-

    - name: Pull regist3 image
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        false \
        || docker build --tag regist3 - <<<'FROM docker.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM mirror.gcr.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM public.ecr.aws/docker/registry:3' \
        || exit 1
    - name: Start "cache from" image registry
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' }}
      run: docker run --name=reg-from --rm --detach -p 12345:5000 --user $(id -u):$(id -g) -v     /tmp/.local-registry:/var/lib/registry regist3
    - name: Start "cache to" image registry
      if: ${{ env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: docker run --name=reg-to   --rm --detach -p 23456:5000 --user $(id -u):$(id -g) -v /tmp/.local-registry-new:/var/lib/registry regist3

    - name: ðŸ”µ Envs
      run: ~/.cargo/bin/cargo-green green supergreen env
    - if: ${{ matrix.toolchain != '1.91.1' }}
      run: ~/.cargo/bin/cargo-green green supergreen env CARGOGREEN_BASE_IMAGE | grep '${{ matrix.toolchain }}'
    - run: ~/.cargo/bin/cargo-green green supergreen builder
    - name: ðŸ”µ Envs again
      run: ~/.cargo/bin/cargo-green green supergreen env

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose
    - name: ðŸ”µ cargo install
      id: cargo-install
      continue-on-error: true
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --locked --force ripgrep@15.1.0  |& tee _
    - name: ðŸ”µ cargo install jobs=1
      #if: ${{ job.steps.cargo-install.outcome == 'failure' }} this actually hides failure of cargo-install step
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --jobs=1 --locked --force ripgrep@15.1.0  |& tee _
    - if: ${{ always() && matrix.toolchain != '1.91.1' }}
      uses: actions/upload-artifact@v7
      name: Upload recipe
      with:
        name: ripgrep@15.1.0.Dockerfile
        path: ${{ env.CARGOGREEN_FINAL_PATH }}
        if-no-files-found: error
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH
    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

    - name: ðŸ”µ Ensure running the same command twice without modifications...
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --locked --force ripgrep@15.1.0  |& tee _
    - name: ...doesn't recompile anything
      run: |
        err=0
        grep Finished  _
        grep Finished  _ | grep -E [012]...s || ((err+=1))
        grep Dirty     _                     && ((err+=2))
        grep Compiling _                     && ((err+=4))
        exit $err
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH

    - name: ðŸ”µ Compare old/new local private registry image digests
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        diff --width=150 -y \
          <(find /tmp/.local-registry/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) \
          <(find /tmp/.local-registry-new/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) || true
        du -sh /tmp/.local-registry /tmp/.local-registry-new || true
    - name: Local private registry cache dance
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # [ci: caches keep growing](https://github.com/moby/buildkit/issues/1850)
        docker stop --timeout 10 reg-from reg-to
        rm -rf /tmp/.local-registry
        mv /tmp/.local-registry-new /tmp/.local-registry
    - name: Save local private registry cache
      uses: actions/cache/save@v5
      if: ${{ false }} # TODO: drop when digests are stable
      with:
        path: /tmp/.local-registry
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

  rublk_0-2-13:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -euo pipefail {0}
    continue-on-error: ${{ matrix.toolchain != '1.91.1' }}
    strategy:
      matrix:
        toolchain:
        - 1.91.1
        - 1.90.0
        exclude:
        - toolchain: ${{ github.ref != 'refs/heads/main' && '1.91.1' }}
    env:
      CARGO_TARGET_DIR: /tmp/clis-rublk_0-2-13
    # CARGOGREEN_CACHE_FROM_IMAGES: docker-image://localhost:12345/${{ github.repository }}
    # CARGOGREEN_CACHE_TO_IMAGES: docker-image://localhost:23456/${{ github.repository }}
      CARGOGREEN_FINAL_PATH: recipes/rublk@0.2.13.Dockerfile
      CARGOGREEN_EXPERIMENT: finalpathnonprimary # dumps on each build call
      CARGOGREEN_LOG: trace
      CARGOGREEN_LOG_PATH: logs.txt

    needs: bin
    steps:
    - uses: docker/login-action@v3
      if: ${{ ! startsWith(github.ref, 'refs/heads/dependabot/') }}
      with:
        username: ${{ vars.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: ${{ matrix.toolchain }}
        rustflags: ''
        cache-on-failure: true


    - name: Retrieve saved bin
      uses: actions/download-artifact@v7
      with:
        name: cargo-green

    - name: Install saved bin
      shell: bash -eu {0}
      run: | # TODO: whence https://github.com/actions/download-artifact/issues/236
        chmod +x ./cargo-green
        { ! ./cargo-green --version ; } | grep cargo-green
        mv ./cargo-green ~/.cargo/bin/
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      name: Retrieve saved builder data
      uses: actions/download-artifact@v7
      with:
        name: builder-data
        path: /home/runner/builder-cache
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      run: |
        set -x
        sudo mkdir -p $(cargo green supergreen sync data 2>/dev/null)
        sudo mv -v /home/runner/builder-cache/* $(cargo green supergreen sync data 2>/dev/null)/
        sudo chown -R root:root $(cargo green supergreen sync data 2>/dev/null)
    - uses: actions/checkout@v6
    - run: docker info
    - run: docker buildx version
    - run: docker buildx build --help
    - run: podman version || true
    - run: cargo -Vv

    - name: Prepare local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # https://github.com/fenollp/supergreen/actions/caches
        mkdir -p /tmp/.local-registry
        mkdir -p /tmp/.local-registry-new
    - name: ðŸ”µ Restore local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      uses: actions/cache/restore@v5
      with:
        path: /tmp/.local-registry
        # github.run_id: https://github.com/actions/toolkit/issues/658#issuecomment-2640690759
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}
        restore-keys: |
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-
          localprivatereg-${{ runner.os }}-
          localprivatereg-

    - name: Pull regist3 image
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        false \
        || docker build --tag regist3 - <<<'FROM docker.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM mirror.gcr.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM public.ecr.aws/docker/registry:3' \
        || exit 1
    - name: Start "cache from" image registry
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' }}
      run: docker run --name=reg-from --rm --detach -p 12345:5000 --user $(id -u):$(id -g) -v     /tmp/.local-registry:/var/lib/registry regist3
    - name: Start "cache to" image registry
      if: ${{ env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: docker run --name=reg-to   --rm --detach -p 23456:5000 --user $(id -u):$(id -g) -v /tmp/.local-registry-new:/var/lib/registry regist3

    - name: ðŸ”µ Envs
      run: ~/.cargo/bin/cargo-green green supergreen env
    - if: ${{ matrix.toolchain != '1.91.1' }}
      run: ~/.cargo/bin/cargo-green green supergreen env CARGOGREEN_BASE_IMAGE | grep '${{ matrix.toolchain }}'
    - run: ~/.cargo/bin/cargo-green green supergreen builder
    - name: ðŸ”µ Envs again
      run: ~/.cargo/bin/cargo-green green supergreen env

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose
    - name: ðŸ”µ cargo install
      id: cargo-install
      continue-on-error: true
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env CARGOGREEN_ADD_APT=libclang-dev \
          cargo green -vv install --locked --force rublk@0.2.13  |& tee _
    - name: ðŸ”µ cargo install jobs=1
      #if: ${{ job.steps.cargo-install.outcome == 'failure' }} this actually hides failure of cargo-install step
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env CARGOGREEN_ADD_APT=libclang-dev \
          cargo green -vv install --jobs=1 --locked --force rublk@0.2.13  |& tee _
    - if: ${{ always() && matrix.toolchain != '1.91.1' }}
      uses: actions/upload-artifact@v7
      name: Upload recipe
      with:
        name: rublk@0.2.13.Dockerfile
        path: ${{ env.CARGOGREEN_FINAL_PATH }}
        if-no-files-found: error
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH
    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

    - name: ðŸ”µ Ensure running the same command twice without modifications...
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env CARGOGREEN_ADD_APT=libclang-dev \
          cargo green -vv install --locked --force rublk@0.2.13  |& tee _
    - name: ...doesn't recompile anything
      run: |
        err=0
        grep Finished  _
        grep Finished  _ | grep -E [012]...s || ((err+=1))
        grep Dirty     _                     && ((err+=2))
        grep Compiling _                     && ((err+=4))
        exit $err
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH

    - name: ðŸ”µ Compare old/new local private registry image digests
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        diff --width=150 -y \
          <(find /tmp/.local-registry/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) \
          <(find /tmp/.local-registry-new/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) || true
        du -sh /tmp/.local-registry /tmp/.local-registry-new || true
    - name: Local private registry cache dance
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # [ci: caches keep growing](https://github.com/moby/buildkit/issues/1850)
        docker stop --timeout 10 reg-from reg-to
        rm -rf /tmp/.local-registry
        mv /tmp/.local-registry-new /tmp/.local-registry
    - name: Save local private registry cache
      uses: actions/cache/save@v5
      if: ${{ false }} # TODO: drop when digests are stable
      with:
        path: /tmp/.local-registry
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

  shpool_0-9-3:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -euo pipefail {0}
    continue-on-error: ${{ matrix.toolchain != '1.91.1' }}
    strategy:
      matrix:
        toolchain:
        - 1.91.1
        - 1.90.0
        exclude:
        - toolchain: ${{ github.ref != 'refs/heads/main' && '1.91.1' }}
    env:
      CARGO_TARGET_DIR: /tmp/clis-shpool_0-9-3
    # CARGOGREEN_CACHE_FROM_IMAGES: docker-image://localhost:12345/${{ github.repository }}
    # CARGOGREEN_CACHE_TO_IMAGES: docker-image://localhost:23456/${{ github.repository }}
      CARGOGREEN_FINAL_PATH: recipes/shpool@0.9.3.Dockerfile
      CARGOGREEN_EXPERIMENT: finalpathnonprimary # dumps on each build call
      CARGOGREEN_LOG: trace
      CARGOGREEN_LOG_PATH: logs.txt

    needs: bin
    steps:
    - uses: docker/login-action@v3
      if: ${{ ! startsWith(github.ref, 'refs/heads/dependabot/') }}
      with:
        username: ${{ vars.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: ${{ matrix.toolchain }}
        rustflags: ''
        cache-on-failure: true


    - name: Retrieve saved bin
      uses: actions/download-artifact@v7
      with:
        name: cargo-green

    - name: Install saved bin
      shell: bash -eu {0}
      run: | # TODO: whence https://github.com/actions/download-artifact/issues/236
        chmod +x ./cargo-green
        { ! ./cargo-green --version ; } | grep cargo-green
        mv ./cargo-green ~/.cargo/bin/
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      name: Retrieve saved builder data
      uses: actions/download-artifact@v7
      with:
        name: builder-data
        path: /home/runner/builder-cache
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      run: |
        set -x
        sudo mkdir -p $(cargo green supergreen sync data 2>/dev/null)
        sudo mv -v /home/runner/builder-cache/* $(cargo green supergreen sync data 2>/dev/null)/
        sudo chown -R root:root $(cargo green supergreen sync data 2>/dev/null)
    - uses: actions/checkout@v6
    - run: docker info
    - run: docker buildx version
    - run: docker buildx build --help
    - run: podman version || true
    - run: cargo -Vv

    - name: Prepare local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # https://github.com/fenollp/supergreen/actions/caches
        mkdir -p /tmp/.local-registry
        mkdir -p /tmp/.local-registry-new
    - name: ðŸ”µ Restore local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      uses: actions/cache/restore@v5
      with:
        path: /tmp/.local-registry
        # github.run_id: https://github.com/actions/toolkit/issues/658#issuecomment-2640690759
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}
        restore-keys: |
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-
          localprivatereg-${{ runner.os }}-
          localprivatereg-

    - name: Pull regist3 image
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        false \
        || docker build --tag regist3 - <<<'FROM docker.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM mirror.gcr.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM public.ecr.aws/docker/registry:3' \
        || exit 1
    - name: Start "cache from" image registry
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' }}
      run: docker run --name=reg-from --rm --detach -p 12345:5000 --user $(id -u):$(id -g) -v     /tmp/.local-registry:/var/lib/registry regist3
    - name: Start "cache to" image registry
      if: ${{ env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: docker run --name=reg-to   --rm --detach -p 23456:5000 --user $(id -u):$(id -g) -v /tmp/.local-registry-new:/var/lib/registry regist3

    - name: ðŸ”µ Envs
      run: ~/.cargo/bin/cargo-green green supergreen env
    - if: ${{ matrix.toolchain != '1.91.1' }}
      run: ~/.cargo/bin/cargo-green green supergreen env CARGOGREEN_BASE_IMAGE | grep '${{ matrix.toolchain }}'
    - run: ~/.cargo/bin/cargo-green green supergreen builder
    - name: ðŸ”µ Envs again
      run: ~/.cargo/bin/cargo-green green supergreen env

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose
    - name: ðŸ”µ cargo install
      id: cargo-install
      continue-on-error: true
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --locked --force shpool@0.9.3  |& tee _
    - name: ðŸ”µ cargo install jobs=1
      #if: ${{ job.steps.cargo-install.outcome == 'failure' }} this actually hides failure of cargo-install step
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --jobs=1 --locked --force shpool@0.9.3  |& tee _
    - if: ${{ always() && matrix.toolchain != '1.91.1' }}
      uses: actions/upload-artifact@v7
      name: Upload recipe
      with:
        name: shpool@0.9.3.Dockerfile
        path: ${{ env.CARGOGREEN_FINAL_PATH }}
        if-no-files-found: error
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH
    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

    - name: ðŸ”µ Ensure running the same command twice without modifications...
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --locked --force shpool@0.9.3  |& tee _
    - name: ...doesn't recompile anything
      run: |
        err=0
        grep Finished  _
        grep Finished  _ | grep -E [012]...s || ((err+=1))
        grep Dirty     _                     && ((err+=2))
        grep Compiling _                     && ((err+=4))
        exit $err
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH

    - name: ðŸ”µ Compare old/new local private registry image digests
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        diff --width=150 -y \
          <(find /tmp/.local-registry/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) \
          <(find /tmp/.local-registry-new/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) || true
        du -sh /tmp/.local-registry /tmp/.local-registry-new || true
    - name: Local private registry cache dance
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # [ci: caches keep growing](https://github.com/moby/buildkit/issues/1850)
        docker stop --timeout 10 reg-from reg-to
        rm -rf /tmp/.local-registry
        mv /tmp/.local-registry-new /tmp/.local-registry
    - name: Save local private registry cache
      uses: actions/cache/save@v5
      if: ${{ false }} # TODO: drop when digests are stable
      with:
        path: /tmp/.local-registry
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

  stu_0-7-5:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -euo pipefail {0}
    continue-on-error: ${{ matrix.toolchain != '1.91.1' }}
    strategy:
      matrix:
        toolchain:
        - 1.91.1
        - 1.90.0
        exclude:
        - toolchain: ${{ github.ref != 'refs/heads/main' && '1.91.1' }}
    env:
      CARGO_TARGET_DIR: /tmp/clis-stu_0-7-5
    # CARGOGREEN_CACHE_FROM_IMAGES: docker-image://localhost:12345/${{ github.repository }}
    # CARGOGREEN_CACHE_TO_IMAGES: docker-image://localhost:23456/${{ github.repository }}
      CARGOGREEN_FINAL_PATH: recipes/stu@0.7.5.Dockerfile
      CARGOGREEN_EXPERIMENT: finalpathnonprimary # dumps on each build call
      CARGOGREEN_LOG: trace
      CARGOGREEN_LOG_PATH: logs.txt

    needs: bin
    steps:
    - uses: docker/login-action@v3
      if: ${{ ! startsWith(github.ref, 'refs/heads/dependabot/') }}
      with:
        username: ${{ vars.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: ${{ matrix.toolchain }}
        rustflags: ''
        cache-on-failure: true


    - name: Retrieve saved bin
      uses: actions/download-artifact@v7
      with:
        name: cargo-green

    - name: Install saved bin
      shell: bash -eu {0}
      run: | # TODO: whence https://github.com/actions/download-artifact/issues/236
        chmod +x ./cargo-green
        { ! ./cargo-green --version ; } | grep cargo-green
        mv ./cargo-green ~/.cargo/bin/
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      name: Retrieve saved builder data
      uses: actions/download-artifact@v7
      with:
        name: builder-data
        path: /home/runner/builder-cache
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      run: |
        set -x
        sudo mkdir -p $(cargo green supergreen sync data 2>/dev/null)
        sudo mv -v /home/runner/builder-cache/* $(cargo green supergreen sync data 2>/dev/null)/
        sudo chown -R root:root $(cargo green supergreen sync data 2>/dev/null)
    - uses: actions/checkout@v6
    - run: docker info
    - run: docker buildx version
    - run: docker buildx build --help
    - run: podman version || true
    - run: cargo -Vv

    - name: Prepare local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # https://github.com/fenollp/supergreen/actions/caches
        mkdir -p /tmp/.local-registry
        mkdir -p /tmp/.local-registry-new
    - name: ðŸ”µ Restore local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      uses: actions/cache/restore@v5
      with:
        path: /tmp/.local-registry
        # github.run_id: https://github.com/actions/toolkit/issues/658#issuecomment-2640690759
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}
        restore-keys: |
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-
          localprivatereg-${{ runner.os }}-
          localprivatereg-

    - name: Pull regist3 image
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        false \
        || docker build --tag regist3 - <<<'FROM docker.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM mirror.gcr.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM public.ecr.aws/docker/registry:3' \
        || exit 1
    - name: Start "cache from" image registry
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' }}
      run: docker run --name=reg-from --rm --detach -p 12345:5000 --user $(id -u):$(id -g) -v     /tmp/.local-registry:/var/lib/registry regist3
    - name: Start "cache to" image registry
      if: ${{ env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: docker run --name=reg-to   --rm --detach -p 23456:5000 --user $(id -u):$(id -g) -v /tmp/.local-registry-new:/var/lib/registry regist3

    - name: ðŸ”µ Envs
      run: ~/.cargo/bin/cargo-green green supergreen env
    - if: ${{ matrix.toolchain != '1.91.1' }}
      run: ~/.cargo/bin/cargo-green green supergreen env CARGOGREEN_BASE_IMAGE | grep '${{ matrix.toolchain }}'
    - run: ~/.cargo/bin/cargo-green green supergreen builder
    - name: ðŸ”µ Envs again
      run: ~/.cargo/bin/cargo-green green supergreen env

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose
    - name: ðŸ”µ cargo install
      id: cargo-install
      continue-on-error: true
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --locked --force stu@0.7.5  |& tee _
    - name: ðŸ”µ cargo install jobs=1
      #if: ${{ job.steps.cargo-install.outcome == 'failure' }} this actually hides failure of cargo-install step
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --jobs=1 --locked --force stu@0.7.5  |& tee _
    - if: ${{ always() && matrix.toolchain != '1.91.1' }}
      uses: actions/upload-artifact@v7
      name: Upload recipe
      with:
        name: stu@0.7.5.Dockerfile
        path: ${{ env.CARGOGREEN_FINAL_PATH }}
        if-no-files-found: error
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH
    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

    - name: ðŸ”µ Ensure running the same command twice without modifications...
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --locked --force stu@0.7.5  |& tee _
    - name: ...doesn't recompile anything
      run: |
        err=0
        grep Finished  _
        grep Finished  _ | grep -E [012]...s || ((err+=1))
        grep Dirty     _                     && ((err+=2))
        grep Compiling _                     && ((err+=4))
        exit $err
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH

    - name: ðŸ”µ Compare old/new local private registry image digests
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        diff --width=150 -y \
          <(find /tmp/.local-registry/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) \
          <(find /tmp/.local-registry-new/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) || true
        du -sh /tmp/.local-registry /tmp/.local-registry-new || true
    - name: Local private registry cache dance
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # [ci: caches keep growing](https://github.com/moby/buildkit/issues/1850)
        docker stop --timeout 10 reg-from reg-to
        rm -rf /tmp/.local-registry
        mv /tmp/.local-registry-new /tmp/.local-registry
    - name: Save local private registry cache
      uses: actions/cache/save@v5
      if: ${{ false }} # TODO: drop when digests are stable
      with:
        path: /tmp/.local-registry
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

  cargo-authors_0-5-5:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -euo pipefail {0}
    continue-on-error: ${{ matrix.toolchain != '1.91.1' }}
    strategy:
      matrix:
        toolchain:
        - 1.91.1
        - 1.90.0
        exclude:
        - toolchain: ${{ github.ref != 'refs/heads/main' && '1.91.1' }}
    env:
      CARGO_TARGET_DIR: /tmp/clis-cargo-authors_0-5-5
    # CARGOGREEN_CACHE_FROM_IMAGES: docker-image://localhost:12345/${{ github.repository }}
    # CARGOGREEN_CACHE_TO_IMAGES: docker-image://localhost:23456/${{ github.repository }}
      CARGOGREEN_FINAL_PATH: recipes/cargo-authors@0.5.5.Dockerfile
      CARGOGREEN_EXPERIMENT: finalpathnonprimary # dumps on each build call
      CARGOGREEN_LOG: trace
      CARGOGREEN_LOG_PATH: logs.txt

    needs: bin
    steps:
    - uses: docker/login-action@v3
      if: ${{ ! startsWith(github.ref, 'refs/heads/dependabot/') }}
      with:
        username: ${{ vars.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: ${{ matrix.toolchain }}
        rustflags: ''
        cache-on-failure: true


    - name: Retrieve saved bin
      uses: actions/download-artifact@v7
      with:
        name: cargo-green

    - name: Install saved bin
      shell: bash -eu {0}
      run: | # TODO: whence https://github.com/actions/download-artifact/issues/236
        chmod +x ./cargo-green
        { ! ./cargo-green --version ; } | grep cargo-green
        mv ./cargo-green ~/.cargo/bin/
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      name: Retrieve saved builder data
      uses: actions/download-artifact@v7
      with:
        name: builder-data
        path: /home/runner/builder-cache
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      run: |
        set -x
        sudo mkdir -p $(cargo green supergreen sync data 2>/dev/null)
        sudo mv -v /home/runner/builder-cache/* $(cargo green supergreen sync data 2>/dev/null)/
        sudo chown -R root:root $(cargo green supergreen sync data 2>/dev/null)
    - uses: actions/checkout@v6
    - run: docker info
    - run: docker buildx version
    - run: docker buildx build --help
    - run: podman version || true
    - run: cargo -Vv

    - name: Prepare local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # https://github.com/fenollp/supergreen/actions/caches
        mkdir -p /tmp/.local-registry
        mkdir -p /tmp/.local-registry-new
    - name: ðŸ”µ Restore local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      uses: actions/cache/restore@v5
      with:
        path: /tmp/.local-registry
        # github.run_id: https://github.com/actions/toolkit/issues/658#issuecomment-2640690759
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}
        restore-keys: |
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-
          localprivatereg-${{ runner.os }}-
          localprivatereg-

    - name: Pull regist3 image
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        false \
        || docker build --tag regist3 - <<<'FROM docker.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM mirror.gcr.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM public.ecr.aws/docker/registry:3' \
        || exit 1
    - name: Start "cache from" image registry
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' }}
      run: docker run --name=reg-from --rm --detach -p 12345:5000 --user $(id -u):$(id -g) -v     /tmp/.local-registry:/var/lib/registry regist3
    - name: Start "cache to" image registry
      if: ${{ env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: docker run --name=reg-to   --rm --detach -p 23456:5000 --user $(id -u):$(id -g) -v /tmp/.local-registry-new:/var/lib/registry regist3

    - name: ðŸ”µ Envs
      run: ~/.cargo/bin/cargo-green green supergreen env
    - if: ${{ matrix.toolchain != '1.91.1' }}
      run: ~/.cargo/bin/cargo-green green supergreen env CARGOGREEN_BASE_IMAGE | grep '${{ matrix.toolchain }}'
    - run: ~/.cargo/bin/cargo-green green supergreen builder
    - name: ðŸ”µ Envs again
      run: ~/.cargo/bin/cargo-green green supergreen env

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose
    - name: ðŸ”µ cargo install
      id: cargo-install
      continue-on-error: true
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env CARGOGREEN_ADD_APT=libcurl4-openssl-dev,pkg-config \
          cargo green -vv install --locked --force cargo-authors@0.5.5  |& tee _
    - name: ðŸ”µ cargo install jobs=1
      #if: ${{ job.steps.cargo-install.outcome == 'failure' }} this actually hides failure of cargo-install step
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env CARGOGREEN_ADD_APT=libcurl4-openssl-dev,pkg-config \
          cargo green -vv install --jobs=1 --locked --force cargo-authors@0.5.5  |& tee _
    - if: ${{ always() && matrix.toolchain != '1.91.1' }}
      uses: actions/upload-artifact@v7
      name: Upload recipe
      with:
        name: cargo-authors@0.5.5.Dockerfile
        path: ${{ env.CARGOGREEN_FINAL_PATH }}
        if-no-files-found: error
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH
    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

    - name: ðŸ”µ Ensure running the same command twice without modifications...
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env CARGOGREEN_ADD_APT=libcurl4-openssl-dev,pkg-config \
          cargo green -vv install --locked --force cargo-authors@0.5.5  |& tee _
    - name: ...doesn't recompile anything
      run: |
        err=0
        grep Finished  _
        grep Finished  _ | grep -E [012]...s || ((err+=1))
        grep Dirty     _                     && ((err+=2))
        grep Compiling _                     && ((err+=4))
        exit $err
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH

    - name: ðŸ”µ Compare old/new local private registry image digests
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        diff --width=150 -y \
          <(find /tmp/.local-registry/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) \
          <(find /tmp/.local-registry-new/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) || true
        du -sh /tmp/.local-registry /tmp/.local-registry-new || true
    - name: Local private registry cache dance
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # [ci: caches keep growing](https://github.com/moby/buildkit/issues/1850)
        docker stop --timeout 10 reg-from reg-to
        rm -rf /tmp/.local-registry
        mv /tmp/.local-registry-new /tmp/.local-registry
    - name: Save local private registry cache
      uses: actions/cache/save@v5
      if: ${{ false }} # TODO: drop when digests are stable
      with:
        path: /tmp/.local-registry
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

  vixargs_0-1-0:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -euo pipefail {0}
    continue-on-error: ${{ matrix.toolchain != '1.91.1' }}
    strategy:
      matrix:
        toolchain:
        - 1.91.1
        - 1.90.0
        exclude:
        - toolchain: ${{ github.ref != 'refs/heads/main' && '1.91.1' }}
    env:
      CARGO_TARGET_DIR: /tmp/clis-vixargs_0-1-0
    # CARGOGREEN_CACHE_FROM_IMAGES: docker-image://localhost:12345/${{ github.repository }}
    # CARGOGREEN_CACHE_TO_IMAGES: docker-image://localhost:23456/${{ github.repository }}
      CARGOGREEN_FINAL_PATH: recipes/vixargs@0.1.0.Dockerfile
      CARGOGREEN_EXPERIMENT: finalpathnonprimary # dumps on each build call
      CARGOGREEN_LOG: trace
      CARGOGREEN_LOG_PATH: logs.txt

    needs: bin
    steps:
    - uses: docker/login-action@v3
      if: ${{ ! startsWith(github.ref, 'refs/heads/dependabot/') }}
      with:
        username: ${{ vars.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: ${{ matrix.toolchain }}
        rustflags: ''
        cache-on-failure: true


    - name: Retrieve saved bin
      uses: actions/download-artifact@v7
      with:
        name: cargo-green

    - name: Install saved bin
      shell: bash -eu {0}
      run: | # TODO: whence https://github.com/actions/download-artifact/issues/236
        chmod +x ./cargo-green
        { ! ./cargo-green --version ; } | grep cargo-green
        mv ./cargo-green ~/.cargo/bin/
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      name: Retrieve saved builder data
      uses: actions/download-artifact@v7
      with:
        name: builder-data
        path: /home/runner/builder-cache
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      run: |
        set -x
        sudo mkdir -p $(cargo green supergreen sync data 2>/dev/null)
        sudo mv -v /home/runner/builder-cache/* $(cargo green supergreen sync data 2>/dev/null)/
        sudo chown -R root:root $(cargo green supergreen sync data 2>/dev/null)
    - uses: actions/checkout@v6
    - run: docker info
    - run: docker buildx version
    - run: docker buildx build --help
    - run: podman version || true
    - run: cargo -Vv

    - name: Prepare local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # https://github.com/fenollp/supergreen/actions/caches
        mkdir -p /tmp/.local-registry
        mkdir -p /tmp/.local-registry-new
    - name: ðŸ”µ Restore local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      uses: actions/cache/restore@v5
      with:
        path: /tmp/.local-registry
        # github.run_id: https://github.com/actions/toolkit/issues/658#issuecomment-2640690759
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}
        restore-keys: |
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-
          localprivatereg-${{ runner.os }}-
          localprivatereg-

    - name: Pull regist3 image
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        false \
        || docker build --tag regist3 - <<<'FROM docker.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM mirror.gcr.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM public.ecr.aws/docker/registry:3' \
        || exit 1
    - name: Start "cache from" image registry
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' }}
      run: docker run --name=reg-from --rm --detach -p 12345:5000 --user $(id -u):$(id -g) -v     /tmp/.local-registry:/var/lib/registry regist3
    - name: Start "cache to" image registry
      if: ${{ env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: docker run --name=reg-to   --rm --detach -p 23456:5000 --user $(id -u):$(id -g) -v /tmp/.local-registry-new:/var/lib/registry regist3

    - name: ðŸ”µ Envs
      run: ~/.cargo/bin/cargo-green green supergreen env
    - if: ${{ matrix.toolchain != '1.91.1' }}
      run: ~/.cargo/bin/cargo-green green supergreen env CARGOGREEN_BASE_IMAGE | grep '${{ matrix.toolchain }}'
    - run: ~/.cargo/bin/cargo-green green supergreen builder
    - name: ðŸ”µ Envs again
      run: ~/.cargo/bin/cargo-green green supergreen env

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose
    - name: ðŸ”µ cargo install
      id: cargo-install
      continue-on-error: true
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --locked --force vixargs@0.1.0  |& tee _
    - name: ðŸ”µ cargo install jobs=1
      #if: ${{ job.steps.cargo-install.outcome == 'failure' }} this actually hides failure of cargo-install step
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --jobs=1 --locked --force vixargs@0.1.0  |& tee _
    - if: ${{ always() && matrix.toolchain != '1.91.1' }}
      uses: actions/upload-artifact@v7
      name: Upload recipe
      with:
        name: vixargs@0.1.0.Dockerfile
        path: ${{ env.CARGOGREEN_FINAL_PATH }}
        if-no-files-found: error
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH
    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

    - name: ðŸ”µ Ensure running the same command twice without modifications...
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --locked --force vixargs@0.1.0  |& tee _
    - name: ...doesn't recompile anything
      run: |
        err=0
        grep Finished  _
        grep Finished  _ | grep -E [012]...s || ((err+=1))
        grep Dirty     _                     && ((err+=2))
        grep Compiling _                     && ((err+=4))
        exit $err
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH

    - name: ðŸ”µ Compare old/new local private registry image digests
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        diff --width=150 -y \
          <(find /tmp/.local-registry/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) \
          <(find /tmp/.local-registry-new/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) || true
        du -sh /tmp/.local-registry /tmp/.local-registry-new || true
    - name: Local private registry cache dance
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # [ci: caches keep growing](https://github.com/moby/buildkit/issues/1850)
        docker stop --timeout 10 reg-from reg-to
        rm -rf /tmp/.local-registry
        mv /tmp/.local-registry-new /tmp/.local-registry
    - name: Save local private registry cache
      uses: actions/cache/save@v5
      if: ${{ false }} # TODO: drop when digests are stable
      with:
        path: /tmp/.local-registry
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

  cargo-config2_0-1-39:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -euo pipefail {0}
    continue-on-error: ${{ matrix.toolchain != '1.91.1' }}
    strategy:
      matrix:
        toolchain:
        - 1.91.1
        - 1.90.0
        exclude:
        - toolchain: ${{ github.ref != 'refs/heads/main' && '1.91.1' }}
    env:
      CARGO_TARGET_DIR: /tmp/clis-cargo-config2_0-1-39
    # CARGOGREEN_CACHE_FROM_IMAGES: docker-image://localhost:12345/${{ github.repository }}
    # CARGOGREEN_CACHE_TO_IMAGES: docker-image://localhost:23456/${{ github.repository }}
      CARGOGREEN_FINAL_PATH: recipes/cargo-config2@0.1.39.Dockerfile
      CARGOGREEN_EXPERIMENT: finalpathnonprimary # dumps on each build call
      CARGOGREEN_LOG: trace
      CARGOGREEN_LOG_PATH: logs.txt

    needs: bin
    steps:
    - uses: docker/login-action@v3
      if: ${{ ! startsWith(github.ref, 'refs/heads/dependabot/') }}
      with:
        username: ${{ vars.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: ${{ matrix.toolchain }}
        rustflags: ''
        cache-on-failure: true


    - name: Retrieve saved bin
      uses: actions/download-artifact@v7
      with:
        name: cargo-green

    - name: Install saved bin
      shell: bash -eu {0}
      run: | # TODO: whence https://github.com/actions/download-artifact/issues/236
        chmod +x ./cargo-green
        { ! ./cargo-green --version ; } | grep cargo-green
        mv ./cargo-green ~/.cargo/bin/
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      name: Retrieve saved builder data
      uses: actions/download-artifact@v7
      with:
        name: builder-data
        path: /home/runner/builder-cache
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      run: |
        set -x
        sudo mkdir -p $(cargo green supergreen sync data 2>/dev/null)
        sudo mv -v /home/runner/builder-cache/* $(cargo green supergreen sync data 2>/dev/null)/
        sudo chown -R root:root $(cargo green supergreen sync data 2>/dev/null)
    - uses: actions/checkout@v6
    - run: docker info
    - run: docker buildx version
    - run: docker buildx build --help
    - run: podman version || true
    - run: cargo -Vv

    - name: Prepare local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # https://github.com/fenollp/supergreen/actions/caches
        mkdir -p /tmp/.local-registry
        mkdir -p /tmp/.local-registry-new
    - name: ðŸ”µ Restore local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      uses: actions/cache/restore@v5
      with:
        path: /tmp/.local-registry
        # github.run_id: https://github.com/actions/toolkit/issues/658#issuecomment-2640690759
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}
        restore-keys: |
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-
          localprivatereg-${{ runner.os }}-
          localprivatereg-

    - name: Pull regist3 image
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        false \
        || docker build --tag regist3 - <<<'FROM docker.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM mirror.gcr.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM public.ecr.aws/docker/registry:3' \
        || exit 1
    - name: Start "cache from" image registry
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' }}
      run: docker run --name=reg-from --rm --detach -p 12345:5000 --user $(id -u):$(id -g) -v     /tmp/.local-registry:/var/lib/registry regist3
    - name: Start "cache to" image registry
      if: ${{ env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: docker run --name=reg-to   --rm --detach -p 23456:5000 --user $(id -u):$(id -g) -v /tmp/.local-registry-new:/var/lib/registry regist3

    - name: ðŸ”µ Envs
      run: ~/.cargo/bin/cargo-green green supergreen env
    - if: ${{ matrix.toolchain != '1.91.1' }}
      run: ~/.cargo/bin/cargo-green green supergreen env CARGOGREEN_BASE_IMAGE | grep '${{ matrix.toolchain }}'
    - run: ~/.cargo/bin/cargo-green green supergreen builder
    - name: ðŸ”µ Envs again
      run: ~/.cargo/bin/cargo-green green supergreen env

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose
    - name: ðŸ”µ cargo install
      id: cargo-install
      continue-on-error: true
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --locked --force cargo-config2@0.1.39 --example=get |& tee _
    - name: ðŸ”µ cargo install jobs=1
      #if: ${{ job.steps.cargo-install.outcome == 'failure' }} this actually hides failure of cargo-install step
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --jobs=1 --locked --force cargo-config2@0.1.39 --example=get |& tee _
    - if: ${{ always() && matrix.toolchain != '1.91.1' }}
      uses: actions/upload-artifact@v7
      name: Upload recipe
      with:
        name: cargo-config2@0.1.39.Dockerfile
        path: ${{ env.CARGOGREEN_FINAL_PATH }}
        if-no-files-found: error
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH
    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

    - name: ðŸ”µ Ensure running the same command twice without modifications...
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --locked --force cargo-config2@0.1.39 --example=get |& tee _
    - name: ...doesn't recompile anything
      run: |
        err=0
        grep Finished  _
        grep Finished  _ | grep -E [012]...s || ((err+=1))
        grep Dirty     _                     && ((err+=2))
        grep Compiling _                     && ((err+=4))
        exit $err
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH

    - name: ðŸ”µ Compare old/new local private registry image digests
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        diff --width=150 -y \
          <(find /tmp/.local-registry/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) \
          <(find /tmp/.local-registry-new/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) || true
        du -sh /tmp/.local-registry /tmp/.local-registry-new || true
    - name: Local private registry cache dance
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # [ci: caches keep growing](https://github.com/moby/buildkit/issues/1850)
        docker stop --timeout 10 reg-from reg-to
        rm -rf /tmp/.local-registry
        mv /tmp/.local-registry-new /tmp/.local-registry
    - name: Save local private registry cache
      uses: actions/cache/save@v5
      if: ${{ false }} # TODO: drop when digests are stable
      with:
        path: /tmp/.local-registry
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

  kani-verifier_0-66-0:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -euo pipefail {0}
    continue-on-error: ${{ matrix.toolchain != '1.91.1' }}
    strategy:
      matrix:
        toolchain:
        - 1.91.1
        - 1.90.0
        exclude:
        - toolchain: ${{ github.ref != 'refs/heads/main' && '1.91.1' }}
    env:
      CARGO_TARGET_DIR: /tmp/clis-kani-verifier_0-66-0
    # CARGOGREEN_CACHE_FROM_IMAGES: docker-image://localhost:12345/${{ github.repository }}
    # CARGOGREEN_CACHE_TO_IMAGES: docker-image://localhost:23456/${{ github.repository }}
      CARGOGREEN_FINAL_PATH: recipes/kani-verifier@0.66.0.Dockerfile
      CARGOGREEN_EXPERIMENT: finalpathnonprimary # dumps on each build call
      CARGOGREEN_LOG: trace
      CARGOGREEN_LOG_PATH: logs.txt

    needs: bin
    steps:
    - uses: docker/login-action@v3
      if: ${{ ! startsWith(github.ref, 'refs/heads/dependabot/') }}
      with:
        username: ${{ vars.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: ${{ matrix.toolchain }}
        rustflags: ''
        cache-on-failure: true


    - name: Retrieve saved bin
      uses: actions/download-artifact@v7
      with:
        name: cargo-green

    - name: Install saved bin
      shell: bash -eu {0}
      run: | # TODO: whence https://github.com/actions/download-artifact/issues/236
        chmod +x ./cargo-green
        { ! ./cargo-green --version ; } | grep cargo-green
        mv ./cargo-green ~/.cargo/bin/
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      name: Retrieve saved builder data
      uses: actions/download-artifact@v7
      with:
        name: builder-data
        path: /home/runner/builder-cache
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      run: |
        set -x
        sudo mkdir -p $(cargo green supergreen sync data 2>/dev/null)
        sudo mv -v /home/runner/builder-cache/* $(cargo green supergreen sync data 2>/dev/null)/
        sudo chown -R root:root $(cargo green supergreen sync data 2>/dev/null)
    - uses: actions/checkout@v6
    - run: docker info
    - run: docker buildx version
    - run: docker buildx build --help
    - run: podman version || true
    - run: cargo -Vv

    - name: Prepare local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # https://github.com/fenollp/supergreen/actions/caches
        mkdir -p /tmp/.local-registry
        mkdir -p /tmp/.local-registry-new
    - name: ðŸ”µ Restore local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      uses: actions/cache/restore@v5
      with:
        path: /tmp/.local-registry
        # github.run_id: https://github.com/actions/toolkit/issues/658#issuecomment-2640690759
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}
        restore-keys: |
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-
          localprivatereg-${{ runner.os }}-
          localprivatereg-

    - name: Pull regist3 image
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        false \
        || docker build --tag regist3 - <<<'FROM docker.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM mirror.gcr.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM public.ecr.aws/docker/registry:3' \
        || exit 1
    - name: Start "cache from" image registry
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' }}
      run: docker run --name=reg-from --rm --detach -p 12345:5000 --user $(id -u):$(id -g) -v     /tmp/.local-registry:/var/lib/registry regist3
    - name: Start "cache to" image registry
      if: ${{ env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: docker run --name=reg-to   --rm --detach -p 23456:5000 --user $(id -u):$(id -g) -v /tmp/.local-registry-new:/var/lib/registry regist3

    - name: ðŸ”µ Envs
      run: ~/.cargo/bin/cargo-green green supergreen env
    - if: ${{ matrix.toolchain != '1.91.1' }}
      run: ~/.cargo/bin/cargo-green green supergreen env CARGOGREEN_BASE_IMAGE | grep '${{ matrix.toolchain }}'
    - run: ~/.cargo/bin/cargo-green green supergreen builder
    - name: ðŸ”µ Envs again
      run: ~/.cargo/bin/cargo-green green supergreen env

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose
    - name: ðŸ”µ cargo install
      id: cargo-install
      continue-on-error: true
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --locked --force kani-verifier@0.66.0 --bin=cargo-kani |& tee _
    - name: ðŸ”µ cargo install jobs=1
      #if: ${{ job.steps.cargo-install.outcome == 'failure' }} this actually hides failure of cargo-install step
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --jobs=1 --locked --force kani-verifier@0.66.0 --bin=cargo-kani |& tee _
    - if: ${{ always() && matrix.toolchain != '1.91.1' }}
      uses: actions/upload-artifact@v7
      name: Upload recipe
      with:
        name: kani-verifier@0.66.0.Dockerfile
        path: ${{ env.CARGOGREEN_FINAL_PATH }}
        if-no-files-found: error
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH
    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

    - name: ðŸ”µ Ensure running the same command twice without modifications...
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --locked --force kani-verifier@0.66.0 --bin=cargo-kani |& tee _
    - name: ...doesn't recompile anything
      run: |
        err=0
        grep Finished  _
        grep Finished  _ | grep -E [012]...s || ((err+=1))
        grep Dirty     _                     && ((err+=2))
        grep Compiling _                     && ((err+=4))
        exit $err
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH

    - name: ðŸ”µ Compare old/new local private registry image digests
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        diff --width=150 -y \
          <(find /tmp/.local-registry/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) \
          <(find /tmp/.local-registry-new/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) || true
        du -sh /tmp/.local-registry /tmp/.local-registry-new || true
    - name: Local private registry cache dance
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # [ci: caches keep growing](https://github.com/moby/buildkit/issues/1850)
        docker stop --timeout 10 reg-from reg-to
        rm -rf /tmp/.local-registry
        mv /tmp/.local-registry-new /tmp/.local-registry
    - name: Save local private registry cache
      uses: actions/cache/save@v5
      if: ${{ false }} # TODO: drop when digests are stable
      with:
        path: /tmp/.local-registry
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

  cargo-tally_1-0-71:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -euo pipefail {0}
    continue-on-error: ${{ matrix.toolchain != '1.91.1' }}
    strategy:
      matrix:
        toolchain:
        - 1.91.1
        - 1.90.0
        exclude:
        - toolchain: ${{ github.ref != 'refs/heads/main' && '1.91.1' }}
    env:
      CARGO_TARGET_DIR: /tmp/clis-cargo-tally_1-0-71
    # CARGOGREEN_CACHE_FROM_IMAGES: docker-image://localhost:12345/${{ github.repository }}
    # CARGOGREEN_CACHE_TO_IMAGES: docker-image://localhost:23456/${{ github.repository }}
      CARGOGREEN_FINAL_PATH: recipes/cargo-tally@1.0.71.Dockerfile
      CARGOGREEN_EXPERIMENT: finalpathnonprimary # dumps on each build call
      CARGOGREEN_LOG: trace
      CARGOGREEN_LOG_PATH: logs.txt

    needs: bin
    steps:
    - uses: docker/login-action@v3
      if: ${{ ! startsWith(github.ref, 'refs/heads/dependabot/') }}
      with:
        username: ${{ vars.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: ${{ matrix.toolchain }}
        rustflags: ''
        cache-on-failure: true


    - name: Retrieve saved bin
      uses: actions/download-artifact@v7
      with:
        name: cargo-green

    - name: Install saved bin
      shell: bash -eu {0}
      run: | # TODO: whence https://github.com/actions/download-artifact/issues/236
        chmod +x ./cargo-green
        { ! ./cargo-green --version ; } | grep cargo-green
        mv ./cargo-green ~/.cargo/bin/
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      name: Retrieve saved builder data
      uses: actions/download-artifact@v7
      with:
        name: builder-data
        path: /home/runner/builder-cache
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      run: |
        set -x
        sudo mkdir -p $(cargo green supergreen sync data 2>/dev/null)
        sudo mv -v /home/runner/builder-cache/* $(cargo green supergreen sync data 2>/dev/null)/
        sudo chown -R root:root $(cargo green supergreen sync data 2>/dev/null)
    - uses: actions/checkout@v6
    - run: docker info
    - run: docker buildx version
    - run: docker buildx build --help
    - run: podman version || true
    - run: cargo -Vv

    - name: Prepare local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # https://github.com/fenollp/supergreen/actions/caches
        mkdir -p /tmp/.local-registry
        mkdir -p /tmp/.local-registry-new
    - name: ðŸ”µ Restore local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      uses: actions/cache/restore@v5
      with:
        path: /tmp/.local-registry
        # github.run_id: https://github.com/actions/toolkit/issues/658#issuecomment-2640690759
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}
        restore-keys: |
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-
          localprivatereg-${{ runner.os }}-
          localprivatereg-

    - name: Pull regist3 image
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        false \
        || docker build --tag regist3 - <<<'FROM docker.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM mirror.gcr.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM public.ecr.aws/docker/registry:3' \
        || exit 1
    - name: Start "cache from" image registry
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' }}
      run: docker run --name=reg-from --rm --detach -p 12345:5000 --user $(id -u):$(id -g) -v     /tmp/.local-registry:/var/lib/registry regist3
    - name: Start "cache to" image registry
      if: ${{ env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: docker run --name=reg-to   --rm --detach -p 23456:5000 --user $(id -u):$(id -g) -v /tmp/.local-registry-new:/var/lib/registry regist3

    - name: ðŸ”µ Envs
      run: ~/.cargo/bin/cargo-green green supergreen env
    - if: ${{ matrix.toolchain != '1.91.1' }}
      run: ~/.cargo/bin/cargo-green green supergreen env CARGOGREEN_BASE_IMAGE | grep '${{ matrix.toolchain }}'
    - run: ~/.cargo/bin/cargo-green green supergreen builder
    - name: ðŸ”µ Envs again
      run: ~/.cargo/bin/cargo-green green supergreen env

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose
    - name: ðŸ”µ cargo install
      id: cargo-install
      continue-on-error: true
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --locked --force cargo-tally@1.0.71  |& tee _
    - name: ðŸ”µ cargo install jobs=1
      #if: ${{ job.steps.cargo-install.outcome == 'failure' }} this actually hides failure of cargo-install step
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --jobs=1 --locked --force cargo-tally@1.0.71  |& tee _
    - if: ${{ always() && matrix.toolchain != '1.91.1' }}
      uses: actions/upload-artifact@v7
      name: Upload recipe
      with:
        name: cargo-tally@1.0.71.Dockerfile
        path: ${{ env.CARGOGREEN_FINAL_PATH }}
        if-no-files-found: error
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH
    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

    - name: ðŸ”µ Ensure running the same command twice without modifications...
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --locked --force cargo-tally@1.0.71  |& tee _
    - name: ...doesn't recompile anything
      run: |
        err=0
        grep Finished  _
        grep Finished  _ | grep -E [012]...s || ((err+=1))
        grep Dirty     _                     && ((err+=2))
        grep Compiling _                     && ((err+=4))
        exit $err
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH

    - name: ðŸ”µ Compare old/new local private registry image digests
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        diff --width=150 -y \
          <(find /tmp/.local-registry/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) \
          <(find /tmp/.local-registry-new/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) || true
        du -sh /tmp/.local-registry /tmp/.local-registry-new || true
    - name: Local private registry cache dance
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # [ci: caches keep growing](https://github.com/moby/buildkit/issues/1850)
        docker stop --timeout 10 reg-from reg-to
        rm -rf /tmp/.local-registry
        mv /tmp/.local-registry-new /tmp/.local-registry
    - name: Save local private registry cache
      uses: actions/cache/save@v5
      if: ${{ false }} # TODO: drop when digests are stable
      with:
        path: /tmp/.local-registry
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

  cargo-mutants_25-3-1:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -euo pipefail {0}
    continue-on-error: ${{ matrix.toolchain != '1.91.1' }}
    strategy:
      matrix:
        toolchain:
        - 1.91.1
        - 1.90.0
        exclude:
        - toolchain: ${{ github.ref != 'refs/heads/main' && '1.91.1' }}
    env:
      CARGO_TARGET_DIR: /tmp/clis-cargo-mutants_25-3-1
    # CARGOGREEN_CACHE_FROM_IMAGES: docker-image://localhost:12345/${{ github.repository }}
    # CARGOGREEN_CACHE_TO_IMAGES: docker-image://localhost:23456/${{ github.repository }}
      CARGOGREEN_FINAL_PATH: recipes/cargo-mutants@25.3.1.Dockerfile
      CARGOGREEN_EXPERIMENT: finalpathnonprimary # dumps on each build call
      CARGOGREEN_LOG: trace
      CARGOGREEN_LOG_PATH: logs.txt

    needs: bin
    steps:
    - uses: docker/login-action@v3
      if: ${{ ! startsWith(github.ref, 'refs/heads/dependabot/') }}
      with:
        username: ${{ vars.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: ${{ matrix.toolchain }}
        rustflags: ''
        cache-on-failure: true


    - name: Retrieve saved bin
      uses: actions/download-artifact@v7
      with:
        name: cargo-green

    - name: Install saved bin
      shell: bash -eu {0}
      run: | # TODO: whence https://github.com/actions/download-artifact/issues/236
        chmod +x ./cargo-green
        { ! ./cargo-green --version ; } | grep cargo-green
        mv ./cargo-green ~/.cargo/bin/
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      name: Retrieve saved builder data
      uses: actions/download-artifact@v7
      with:
        name: builder-data
        path: /home/runner/builder-cache
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      run: |
        set -x
        sudo mkdir -p $(cargo green supergreen sync data 2>/dev/null)
        sudo mv -v /home/runner/builder-cache/* $(cargo green supergreen sync data 2>/dev/null)/
        sudo chown -R root:root $(cargo green supergreen sync data 2>/dev/null)
    - uses: actions/checkout@v6
    - run: docker info
    - run: docker buildx version
    - run: docker buildx build --help
    - run: podman version || true
    - run: cargo -Vv

    - name: Prepare local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # https://github.com/fenollp/supergreen/actions/caches
        mkdir -p /tmp/.local-registry
        mkdir -p /tmp/.local-registry-new
    - name: ðŸ”µ Restore local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      uses: actions/cache/restore@v5
      with:
        path: /tmp/.local-registry
        # github.run_id: https://github.com/actions/toolkit/issues/658#issuecomment-2640690759
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}
        restore-keys: |
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-
          localprivatereg-${{ runner.os }}-
          localprivatereg-

    - name: Pull regist3 image
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        false \
        || docker build --tag regist3 - <<<'FROM docker.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM mirror.gcr.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM public.ecr.aws/docker/registry:3' \
        || exit 1
    - name: Start "cache from" image registry
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' }}
      run: docker run --name=reg-from --rm --detach -p 12345:5000 --user $(id -u):$(id -g) -v     /tmp/.local-registry:/var/lib/registry regist3
    - name: Start "cache to" image registry
      if: ${{ env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: docker run --name=reg-to   --rm --detach -p 23456:5000 --user $(id -u):$(id -g) -v /tmp/.local-registry-new:/var/lib/registry regist3

    - name: ðŸ”µ Envs
      run: ~/.cargo/bin/cargo-green green supergreen env
    - if: ${{ matrix.toolchain != '1.91.1' }}
      run: ~/.cargo/bin/cargo-green green supergreen env CARGOGREEN_BASE_IMAGE | grep '${{ matrix.toolchain }}'
    - run: ~/.cargo/bin/cargo-green green supergreen builder
    - name: ðŸ”µ Envs again
      run: ~/.cargo/bin/cargo-green green supergreen env

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose
    - name: ðŸ”µ cargo install
      id: cargo-install
      continue-on-error: true
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --locked --force cargo-mutants@25.3.1  |& tee _
    - name: ðŸ”µ cargo install jobs=1
      #if: ${{ job.steps.cargo-install.outcome == 'failure' }} this actually hides failure of cargo-install step
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --jobs=1 --locked --force cargo-mutants@25.3.1  |& tee _
    - if: ${{ always() && matrix.toolchain != '1.91.1' }}
      uses: actions/upload-artifact@v7
      name: Upload recipe
      with:
        name: cargo-mutants@25.3.1.Dockerfile
        path: ${{ env.CARGOGREEN_FINAL_PATH }}
        if-no-files-found: error
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH
    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

    - name: ðŸ”µ Ensure running the same command twice without modifications...
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --locked --force cargo-mutants@25.3.1  |& tee _
    - name: ...doesn't recompile anything
      run: |
        err=0
        grep Finished  _
        grep Finished  _ | grep -E [012]...s || ((err+=1))
        grep Dirty     _                     && ((err+=2))
        grep Compiling _                     && ((err+=4))
        exit $err
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH

    - name: ðŸ”µ Compare old/new local private registry image digests
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        diff --width=150 -y \
          <(find /tmp/.local-registry/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) \
          <(find /tmp/.local-registry-new/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) || true
        du -sh /tmp/.local-registry /tmp/.local-registry-new || true
    - name: Local private registry cache dance
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # [ci: caches keep growing](https://github.com/moby/buildkit/issues/1850)
        docker stop --timeout 10 reg-from reg-to
        rm -rf /tmp/.local-registry
        mv /tmp/.local-registry-new /tmp/.local-registry
    - name: Save local private registry cache
      uses: actions/cache/save@v5
      if: ${{ false }} # TODO: drop when digests are stable
      with:
        path: /tmp/.local-registry
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

  binsider_0-3-0:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -euo pipefail {0}
    continue-on-error: ${{ matrix.toolchain != '1.91.1' }}
    strategy:
      matrix:
        toolchain:
        - 1.91.1
        - 1.90.0
        exclude:
        - toolchain: ${{ github.ref != 'refs/heads/main' && '1.91.1' }}
    env:
      CARGO_TARGET_DIR: /tmp/clis-binsider_0-3-0
    # CARGOGREEN_CACHE_FROM_IMAGES: docker-image://localhost:12345/${{ github.repository }}
    # CARGOGREEN_CACHE_TO_IMAGES: docker-image://localhost:23456/${{ github.repository }}
      CARGOGREEN_FINAL_PATH: recipes/binsider@0.3.0.Dockerfile
      CARGOGREEN_EXPERIMENT: finalpathnonprimary # dumps on each build call
      CARGOGREEN_LOG: trace
      CARGOGREEN_LOG_PATH: logs.txt

    needs: bin
    steps:
    - uses: docker/login-action@v3
      if: ${{ ! startsWith(github.ref, 'refs/heads/dependabot/') }}
      with:
        username: ${{ vars.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: ${{ matrix.toolchain }}
        rustflags: ''
        cache-on-failure: true


    - name: Retrieve saved bin
      uses: actions/download-artifact@v7
      with:
        name: cargo-green

    - name: Install saved bin
      shell: bash -eu {0}
      run: | # TODO: whence https://github.com/actions/download-artifact/issues/236
        chmod +x ./cargo-green
        { ! ./cargo-green --version ; } | grep cargo-green
        mv ./cargo-green ~/.cargo/bin/
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      name: Retrieve saved builder data
      uses: actions/download-artifact@v7
      with:
        name: builder-data
        path: /home/runner/builder-cache
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      run: |
        set -x
        sudo mkdir -p $(cargo green supergreen sync data 2>/dev/null)
        sudo mv -v /home/runner/builder-cache/* $(cargo green supergreen sync data 2>/dev/null)/
        sudo chown -R root:root $(cargo green supergreen sync data 2>/dev/null)
    - uses: actions/checkout@v6
    - run: docker info
    - run: docker buildx version
    - run: docker buildx build --help
    - run: podman version || true
    - run: cargo -Vv

    - name: Prepare local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # https://github.com/fenollp/supergreen/actions/caches
        mkdir -p /tmp/.local-registry
        mkdir -p /tmp/.local-registry-new
    - name: ðŸ”µ Restore local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      uses: actions/cache/restore@v5
      with:
        path: /tmp/.local-registry
        # github.run_id: https://github.com/actions/toolkit/issues/658#issuecomment-2640690759
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}
        restore-keys: |
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-
          localprivatereg-${{ runner.os }}-
          localprivatereg-

    - name: Pull regist3 image
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        false \
        || docker build --tag regist3 - <<<'FROM docker.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM mirror.gcr.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM public.ecr.aws/docker/registry:3' \
        || exit 1
    - name: Start "cache from" image registry
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' }}
      run: docker run --name=reg-from --rm --detach -p 12345:5000 --user $(id -u):$(id -g) -v     /tmp/.local-registry:/var/lib/registry regist3
    - name: Start "cache to" image registry
      if: ${{ env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: docker run --name=reg-to   --rm --detach -p 23456:5000 --user $(id -u):$(id -g) -v /tmp/.local-registry-new:/var/lib/registry regist3

    - name: ðŸ”µ Envs
      run: ~/.cargo/bin/cargo-green green supergreen env
    - if: ${{ matrix.toolchain != '1.91.1' }}
      run: ~/.cargo/bin/cargo-green green supergreen env CARGOGREEN_BASE_IMAGE | grep '${{ matrix.toolchain }}'
    - run: ~/.cargo/bin/cargo-green green supergreen builder
    - name: ðŸ”µ Envs again
      run: ~/.cargo/bin/cargo-green green supergreen env

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose
    - name: ðŸ”µ cargo install
      id: cargo-install
      continue-on-error: true
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --locked --force binsider@0.3.0  |& tee _
    - name: ðŸ”µ cargo install jobs=1
      #if: ${{ job.steps.cargo-install.outcome == 'failure' }} this actually hides failure of cargo-install step
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --jobs=1 --locked --force binsider@0.3.0  |& tee _
    - if: ${{ always() && matrix.toolchain != '1.91.1' }}
      uses: actions/upload-artifact@v7
      name: Upload recipe
      with:
        name: binsider@0.3.0.Dockerfile
        path: ${{ env.CARGOGREEN_FINAL_PATH }}
        if-no-files-found: error
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH
    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

    - name: ðŸ”µ Ensure running the same command twice without modifications...
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --locked --force binsider@0.3.0  |& tee _
    - name: ...doesn't recompile anything
      run: |
        err=0
        grep Finished  _
        grep Finished  _ | grep -E [012]...s || ((err+=1))
        grep Dirty     _                     && ((err+=2))
        grep Compiling _                     && ((err+=4))
        exit $err
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH

    - name: ðŸ”µ Compare old/new local private registry image digests
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        diff --width=150 -y \
          <(find /tmp/.local-registry/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) \
          <(find /tmp/.local-registry-new/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) || true
        du -sh /tmp/.local-registry /tmp/.local-registry-new || true
    - name: Local private registry cache dance
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # [ci: caches keep growing](https://github.com/moby/buildkit/issues/1850)
        docker stop --timeout 10 reg-from reg-to
        rm -rf /tmp/.local-registry
        mv /tmp/.local-registry-new /tmp/.local-registry
    - name: Save local private registry cache
      uses: actions/cache/save@v5
      if: ${{ false }} # TODO: drop when digests are stable
      with:
        path: /tmp/.local-registry
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

  gifski_1-34-0:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -euo pipefail {0}
    continue-on-error: ${{ matrix.toolchain != '1.91.1' }}
    strategy:
      matrix:
        toolchain:
        - 1.91.1
        - 1.90.0
        exclude:
        - toolchain: ${{ github.ref != 'refs/heads/main' && '1.91.1' }}
    env:
      CARGO_TARGET_DIR: /tmp/clis-gifski_1-34-0
    # CARGOGREEN_CACHE_FROM_IMAGES: docker-image://localhost:12345/${{ github.repository }}
    # CARGOGREEN_CACHE_TO_IMAGES: docker-image://localhost:23456/${{ github.repository }}
      CARGOGREEN_FINAL_PATH: recipes/gifski@1.34.0.Dockerfile
      CARGOGREEN_EXPERIMENT: finalpathnonprimary # dumps on each build call
      CARGOGREEN_LOG: trace
      CARGOGREEN_LOG_PATH: logs.txt

    needs: bin
    steps:
    - uses: docker/login-action@v3
      if: ${{ ! startsWith(github.ref, 'refs/heads/dependabot/') }}
      with:
        username: ${{ vars.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: ${{ matrix.toolchain }}
        rustflags: ''
        cache-on-failure: true


    - name: Retrieve saved bin
      uses: actions/download-artifact@v7
      with:
        name: cargo-green

    - name: Install saved bin
      shell: bash -eu {0}
      run: | # TODO: whence https://github.com/actions/download-artifact/issues/236
        chmod +x ./cargo-green
        { ! ./cargo-green --version ; } | grep cargo-green
        mv ./cargo-green ~/.cargo/bin/
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      name: Retrieve saved builder data
      uses: actions/download-artifact@v7
      with:
        name: builder-data
        path: /home/runner/builder-cache
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      run: |
        set -x
        sudo mkdir -p $(cargo green supergreen sync data 2>/dev/null)
        sudo mv -v /home/runner/builder-cache/* $(cargo green supergreen sync data 2>/dev/null)/
        sudo chown -R root:root $(cargo green supergreen sync data 2>/dev/null)
    - uses: actions/checkout@v6
    - run: docker info
    - run: docker buildx version
    - run: docker buildx build --help
    - run: podman version || true
    - run: cargo -Vv

    - name: Prepare local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # https://github.com/fenollp/supergreen/actions/caches
        mkdir -p /tmp/.local-registry
        mkdir -p /tmp/.local-registry-new
    - name: ðŸ”µ Restore local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      uses: actions/cache/restore@v5
      with:
        path: /tmp/.local-registry
        # github.run_id: https://github.com/actions/toolkit/issues/658#issuecomment-2640690759
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}
        restore-keys: |
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-
          localprivatereg-${{ runner.os }}-
          localprivatereg-

    - name: Pull regist3 image
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        false \
        || docker build --tag regist3 - <<<'FROM docker.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM mirror.gcr.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM public.ecr.aws/docker/registry:3' \
        || exit 1
    - name: Start "cache from" image registry
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' }}
      run: docker run --name=reg-from --rm --detach -p 12345:5000 --user $(id -u):$(id -g) -v     /tmp/.local-registry:/var/lib/registry regist3
    - name: Start "cache to" image registry
      if: ${{ env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: docker run --name=reg-to   --rm --detach -p 23456:5000 --user $(id -u):$(id -g) -v /tmp/.local-registry-new:/var/lib/registry regist3

    - name: ðŸ”µ Envs
      run: ~/.cargo/bin/cargo-green green supergreen env
    - if: ${{ matrix.toolchain != '1.91.1' }}
      run: ~/.cargo/bin/cargo-green green supergreen env CARGOGREEN_BASE_IMAGE | grep '${{ matrix.toolchain }}'
    - run: ~/.cargo/bin/cargo-green green supergreen builder
    - name: ðŸ”µ Envs again
      run: ~/.cargo/bin/cargo-green green supergreen env

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose
    - name: ðŸ”µ cargo install
      id: cargo-install
      continue-on-error: true
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --locked --force gifski@1.34.0  |& tee _
    - name: ðŸ”µ cargo install jobs=1
      #if: ${{ job.steps.cargo-install.outcome == 'failure' }} this actually hides failure of cargo-install step
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --jobs=1 --locked --force gifski@1.34.0  |& tee _
    - if: ${{ always() && matrix.toolchain != '1.91.1' }}
      uses: actions/upload-artifact@v7
      name: Upload recipe
      with:
        name: gifski@1.34.0.Dockerfile
        path: ${{ env.CARGOGREEN_FINAL_PATH }}
        if-no-files-found: error
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH
    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

    - name: ðŸ”µ Ensure running the same command twice without modifications...
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --locked --force gifski@1.34.0  |& tee _
    - name: ...doesn't recompile anything
      run: |
        err=0
        grep Finished  _
        grep Finished  _ | grep -E [012]...s || ((err+=1))
        grep Dirty     _                     && ((err+=2))
        grep Compiling _                     && ((err+=4))
        exit $err
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH

    - name: ðŸ”µ Compare old/new local private registry image digests
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        diff --width=150 -y \
          <(find /tmp/.local-registry/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) \
          <(find /tmp/.local-registry-new/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) || true
        du -sh /tmp/.local-registry /tmp/.local-registry-new || true
    - name: Local private registry cache dance
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # [ci: caches keep growing](https://github.com/moby/buildkit/issues/1850)
        docker stop --timeout 10 reg-from reg-to
        rm -rf /tmp/.local-registry
        mv /tmp/.local-registry-new /tmp/.local-registry
    - name: Save local private registry cache
      uses: actions/cache/save@v5
      if: ${{ false }} # TODO: drop when digests are stable
      with:
        path: /tmp/.local-registry
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

  flamegraph_0-6-10:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -euo pipefail {0}
    continue-on-error: ${{ matrix.toolchain != '1.91.1' }}
    strategy:
      matrix:
        toolchain:
        - 1.91.1
        - 1.90.0
        exclude:
        - toolchain: ${{ github.ref != 'refs/heads/main' && '1.91.1' }}
    env:
      CARGO_TARGET_DIR: /tmp/clis-flamegraph_0-6-10
    # CARGOGREEN_CACHE_FROM_IMAGES: docker-image://localhost:12345/${{ github.repository }}
    # CARGOGREEN_CACHE_TO_IMAGES: docker-image://localhost:23456/${{ github.repository }}
      CARGOGREEN_FINAL_PATH: recipes/flamegraph@0.6.10.Dockerfile
      CARGOGREEN_EXPERIMENT: finalpathnonprimary # dumps on each build call
      CARGOGREEN_LOG: trace
      CARGOGREEN_LOG_PATH: logs.txt

    needs: bin
    steps:
    - uses: docker/login-action@v3
      if: ${{ ! startsWith(github.ref, 'refs/heads/dependabot/') }}
      with:
        username: ${{ vars.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: ${{ matrix.toolchain }}
        rustflags: ''
        cache-on-failure: true


    - name: Retrieve saved bin
      uses: actions/download-artifact@v7
      with:
        name: cargo-green

    - name: Install saved bin
      shell: bash -eu {0}
      run: | # TODO: whence https://github.com/actions/download-artifact/issues/236
        chmod +x ./cargo-green
        { ! ./cargo-green --version ; } | grep cargo-green
        mv ./cargo-green ~/.cargo/bin/
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      name: Retrieve saved builder data
      uses: actions/download-artifact@v7
      with:
        name: builder-data
        path: /home/runner/builder-cache
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      run: |
        set -x
        sudo mkdir -p $(cargo green supergreen sync data 2>/dev/null)
        sudo mv -v /home/runner/builder-cache/* $(cargo green supergreen sync data 2>/dev/null)/
        sudo chown -R root:root $(cargo green supergreen sync data 2>/dev/null)
    - uses: actions/checkout@v6
    - run: docker info
    - run: docker buildx version
    - run: docker buildx build --help
    - run: podman version || true
    - run: cargo -Vv

    - name: Prepare local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # https://github.com/fenollp/supergreen/actions/caches
        mkdir -p /tmp/.local-registry
        mkdir -p /tmp/.local-registry-new
    - name: ðŸ”µ Restore local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      uses: actions/cache/restore@v5
      with:
        path: /tmp/.local-registry
        # github.run_id: https://github.com/actions/toolkit/issues/658#issuecomment-2640690759
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}
        restore-keys: |
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-
          localprivatereg-${{ runner.os }}-
          localprivatereg-

    - name: Pull regist3 image
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        false \
        || docker build --tag regist3 - <<<'FROM docker.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM mirror.gcr.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM public.ecr.aws/docker/registry:3' \
        || exit 1
    - name: Start "cache from" image registry
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' }}
      run: docker run --name=reg-from --rm --detach -p 12345:5000 --user $(id -u):$(id -g) -v     /tmp/.local-registry:/var/lib/registry regist3
    - name: Start "cache to" image registry
      if: ${{ env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: docker run --name=reg-to   --rm --detach -p 23456:5000 --user $(id -u):$(id -g) -v /tmp/.local-registry-new:/var/lib/registry regist3

    - name: ðŸ”µ Envs
      run: ~/.cargo/bin/cargo-green green supergreen env
    - if: ${{ matrix.toolchain != '1.91.1' }}
      run: ~/.cargo/bin/cargo-green green supergreen env CARGOGREEN_BASE_IMAGE | grep '${{ matrix.toolchain }}'
    - run: ~/.cargo/bin/cargo-green green supergreen builder
    - name: ðŸ”µ Envs again
      run: ~/.cargo/bin/cargo-green green supergreen env

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose
    - name: ðŸ”µ cargo install
      id: cargo-install
      continue-on-error: true
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --locked --force flamegraph@0.6.10  |& tee _
    - name: ðŸ”µ cargo install jobs=1
      #if: ${{ job.steps.cargo-install.outcome == 'failure' }} this actually hides failure of cargo-install step
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --jobs=1 --locked --force flamegraph@0.6.10  |& tee _
    - if: ${{ always() && matrix.toolchain != '1.91.1' }}
      uses: actions/upload-artifact@v7
      name: Upload recipe
      with:
        name: flamegraph@0.6.10.Dockerfile
        path: ${{ env.CARGOGREEN_FINAL_PATH }}
        if-no-files-found: error
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH
    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

    - name: ðŸ”µ Ensure running the same command twice without modifications...
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env  \
          cargo green -vv install --locked --force flamegraph@0.6.10  |& tee _
    - name: ...doesn't recompile anything
      run: |
        err=0
        grep Finished  _
        grep Finished  _ | grep -E [012]...s || ((err+=1))
        grep Dirty     _                     && ((err+=2))
        grep Compiling _                     && ((err+=4))
        exit $err
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH

    - name: ðŸ”µ Compare old/new local private registry image digests
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        diff --width=150 -y \
          <(find /tmp/.local-registry/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) \
          <(find /tmp/.local-registry-new/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) || true
        du -sh /tmp/.local-registry /tmp/.local-registry-new || true
    - name: Local private registry cache dance
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # [ci: caches keep growing](https://github.com/moby/buildkit/issues/1850)
        docker stop --timeout 10 reg-from reg-to
        rm -rf /tmp/.local-registry
        mv /tmp/.local-registry-new /tmp/.local-registry
    - name: Save local private registry cache
      uses: actions/cache/save@v5
      if: ${{ false }} # TODO: drop when digests are stable
      with:
        path: /tmp/.local-registry
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

  sccache_0-12-0:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -euo pipefail {0}
    continue-on-error: ${{ matrix.toolchain != '1.91.1' }}
    strategy:
      matrix:
        toolchain:
        - 1.91.1
        - 1.90.0
        exclude:
        - toolchain: ${{ github.ref != 'refs/heads/main' && '1.91.1' }}
    env:
      CARGO_TARGET_DIR: /tmp/clis-sccache_0-12-0
    # CARGOGREEN_CACHE_FROM_IMAGES: docker-image://localhost:12345/${{ github.repository }}
    # CARGOGREEN_CACHE_TO_IMAGES: docker-image://localhost:23456/${{ github.repository }}
      CARGOGREEN_FINAL_PATH: recipes/sccache@0.12.0.Dockerfile
      CARGOGREEN_EXPERIMENT: finalpathnonprimary # dumps on each build call
      CARGOGREEN_LOG: trace
      CARGOGREEN_LOG_PATH: logs.txt

    needs: bin
    steps:
    - uses: docker/login-action@v3
      if: ${{ ! startsWith(github.ref, 'refs/heads/dependabot/') }}
      with:
        username: ${{ vars.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: ${{ matrix.toolchain }}
        rustflags: ''
        cache-on-failure: true


    - name: Retrieve saved bin
      uses: actions/download-artifact@v7
      with:
        name: cargo-green

    - name: Install saved bin
      shell: bash -eu {0}
      run: | # TODO: whence https://github.com/actions/download-artifact/issues/236
        chmod +x ./cargo-green
        { ! ./cargo-green --version ; } | grep cargo-green
        mv ./cargo-green ~/.cargo/bin/
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      name: Retrieve saved builder data
      uses: actions/download-artifact@v7
      with:
        name: builder-data
        path: /home/runner/builder-cache
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      run: |
        set -x
        sudo mkdir -p $(cargo green supergreen sync data 2>/dev/null)
        sudo mv -v /home/runner/builder-cache/* $(cargo green supergreen sync data 2>/dev/null)/
        sudo chown -R root:root $(cargo green supergreen sync data 2>/dev/null)
    - uses: actions/checkout@v6
    - run: docker info
    - run: docker buildx version
    - run: docker buildx build --help
    - run: podman version || true
    - run: cargo -Vv

    - name: Prepare local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # https://github.com/fenollp/supergreen/actions/caches
        mkdir -p /tmp/.local-registry
        mkdir -p /tmp/.local-registry-new
    - name: ðŸ”µ Restore local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      uses: actions/cache/restore@v5
      with:
        path: /tmp/.local-registry
        # github.run_id: https://github.com/actions/toolkit/issues/658#issuecomment-2640690759
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}
        restore-keys: |
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-
          localprivatereg-${{ runner.os }}-
          localprivatereg-

    - name: Pull regist3 image
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        false \
        || docker build --tag regist3 - <<<'FROM docker.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM mirror.gcr.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM public.ecr.aws/docker/registry:3' \
        || exit 1
    - name: Start "cache from" image registry
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' }}
      run: docker run --name=reg-from --rm --detach -p 12345:5000 --user $(id -u):$(id -g) -v     /tmp/.local-registry:/var/lib/registry regist3
    - name: Start "cache to" image registry
      if: ${{ env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: docker run --name=reg-to   --rm --detach -p 23456:5000 --user $(id -u):$(id -g) -v /tmp/.local-registry-new:/var/lib/registry regist3

    - name: ðŸ”µ Envs
      run: ~/.cargo/bin/cargo-green green supergreen env
    - if: ${{ matrix.toolchain != '1.91.1' }}
      run: ~/.cargo/bin/cargo-green green supergreen env CARGOGREEN_BASE_IMAGE | grep '${{ matrix.toolchain }}'
    - run: ~/.cargo/bin/cargo-green green supergreen builder
    - name: ðŸ”µ Envs again
      run: ~/.cargo/bin/cargo-green green supergreen env

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose
    - name: ðŸ”µ cargo install
      id: cargo-install
      continue-on-error: true
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env CARGOGREEN_ADD_APT=libssl-dev,pkg-config,zlib1g-dev \
          cargo green -vv install --locked --force sccache@0.12.0  |& tee _
    - name: ðŸ”µ cargo install jobs=1
      #if: ${{ job.steps.cargo-install.outcome == 'failure' }} this actually hides failure of cargo-install step
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env CARGOGREEN_ADD_APT=libssl-dev,pkg-config,zlib1g-dev \
          cargo green -vv install --jobs=1 --locked --force sccache@0.12.0  |& tee _
    - if: ${{ always() && matrix.toolchain != '1.91.1' }}
      uses: actions/upload-artifact@v7
      name: Upload recipe
      with:
        name: sccache@0.12.0.Dockerfile
        path: ${{ env.CARGOGREEN_FINAL_PATH }}
        if-no-files-found: error
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH
    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

    - name: ðŸ”µ Ensure running the same command twice without modifications...
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env CARGOGREEN_ADD_APT=libssl-dev,pkg-config,zlib1g-dev \
          cargo green -vv install --locked --force sccache@0.12.0  |& tee _
    - name: ...doesn't recompile anything
      run: |
        err=0
        grep Finished  _
        grep Finished  _ | grep -E [012]...s || ((err+=1))
        grep Dirty     _                     && ((err+=2))
        grep Compiling _                     && ((err+=4))
        exit $err
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH

    - name: ðŸ”µ Compare old/new local private registry image digests
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        diff --width=150 -y \
          <(find /tmp/.local-registry/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) \
          <(find /tmp/.local-registry-new/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) || true
        du -sh /tmp/.local-registry /tmp/.local-registry-new || true
    - name: Local private registry cache dance
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # [ci: caches keep growing](https://github.com/moby/buildkit/issues/1850)
        docker stop --timeout 10 reg-from reg-to
        rm -rf /tmp/.local-registry
        mv /tmp/.local-registry-new /tmp/.local-registry
    - name: Save local private registry cache
      uses: actions/cache/save@v5
      if: ${{ false }} # TODO: drop when digests are stable
      with:
        path: /tmp/.local-registry
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

  bottom_0-11-4:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -euo pipefail {0}
    continue-on-error: ${{ matrix.toolchain != '1.91.1' }}
    strategy:
      matrix:
        toolchain:
        - 1.91.1
        - 1.90.0
        exclude:
        - toolchain: ${{ github.ref != 'refs/heads/main' && '1.91.1' }}
    env:
      CARGO_TARGET_DIR: /tmp/clis-bottom_0-11-4
    # CARGOGREEN_CACHE_FROM_IMAGES: docker-image://localhost:12345/${{ github.repository }}
    # CARGOGREEN_CACHE_TO_IMAGES: docker-image://localhost:23456/${{ github.repository }}
      CARGOGREEN_FINAL_PATH: recipes/bottom@0.11.4.Dockerfile
      CARGOGREEN_EXPERIMENT: finalpathnonprimary # dumps on each build call
      CARGOGREEN_LOG: trace
      CARGOGREEN_LOG_PATH: logs.txt

    needs: bin
    steps:
    - uses: docker/login-action@v3
      if: ${{ ! startsWith(github.ref, 'refs/heads/dependabot/') }}
      with:
        username: ${{ vars.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: ${{ matrix.toolchain }}
        rustflags: ''
        cache-on-failure: true


    - name: Retrieve saved bin
      uses: actions/download-artifact@v7
      with:
        name: cargo-green

    - name: Install saved bin
      shell: bash -eu {0}
      run: | # TODO: whence https://github.com/actions/download-artifact/issues/236
        chmod +x ./cargo-green
        { ! ./cargo-green --version ; } | grep cargo-green
        mv ./cargo-green ~/.cargo/bin/
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      name: Retrieve saved builder data
      uses: actions/download-artifact@v7
      with:
        name: builder-data
        path: /home/runner/builder-cache
    - if: ${{ false }} # TODO: just-sync'd builder cache ends up >500MB (above artifacts free tier)
      run: |
        set -x
        sudo mkdir -p $(cargo green supergreen sync data 2>/dev/null)
        sudo mv -v /home/runner/builder-cache/* $(cargo green supergreen sync data 2>/dev/null)/
        sudo chown -R root:root $(cargo green supergreen sync data 2>/dev/null)
    - uses: actions/checkout@v6
    - run: docker info
    - run: docker buildx version
    - run: docker buildx build --help
    - run: podman version || true
    - run: cargo -Vv

    - name: Prepare local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # https://github.com/fenollp/supergreen/actions/caches
        mkdir -p /tmp/.local-registry
        mkdir -p /tmp/.local-registry-new
    - name: ðŸ”µ Restore local private registry cache
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      uses: actions/cache/restore@v5
      with:
        path: /tmp/.local-registry
        # github.run_id: https://github.com/actions/toolkit/issues/658#issuecomment-2640690759
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}
        restore-keys: |
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-
          localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-
          localprivatereg-${{ runner.os }}-
          localprivatereg-

    - name: Pull regist3 image
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' || env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        false \
        || docker build --tag regist3 - <<<'FROM docker.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM mirror.gcr.io/registry:3' \
        || docker build --tag regist3 - <<<'FROM public.ecr.aws/docker/registry:3' \
        || exit 1
    - name: Start "cache from" image registry
      if: ${{ env.CARGOGREEN_CACHE_FROM_IMAGES != '' }}
      run: docker run --name=reg-from --rm --detach -p 12345:5000 --user $(id -u):$(id -g) -v     /tmp/.local-registry:/var/lib/registry regist3
    - name: Start "cache to" image registry
      if: ${{ env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: docker run --name=reg-to   --rm --detach -p 23456:5000 --user $(id -u):$(id -g) -v /tmp/.local-registry-new:/var/lib/registry regist3

    - name: ðŸ”µ Envs
      run: ~/.cargo/bin/cargo-green green supergreen env
    - if: ${{ matrix.toolchain != '1.91.1' }}
      run: ~/.cargo/bin/cargo-green green supergreen env CARGOGREEN_BASE_IMAGE | grep '${{ matrix.toolchain }}'
    - run: ~/.cargo/bin/cargo-green green supergreen builder
    - name: ðŸ”µ Envs again
      run: ~/.cargo/bin/cargo-green green supergreen env

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose
    - name: ðŸ”µ cargo install
      id: cargo-install
      continue-on-error: true
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env CARGOGREEN_SET_ENVS=GITHUB_SHA GITHUB_SHA= \
          cargo green -vv install --locked --force bottom@0.11.4  |& tee _
    - name: ðŸ”µ cargo install jobs=1
      #if: ${{ job.steps.cargo-install.outcome == 'failure' }} this actually hides failure of cargo-install step
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env CARGOGREEN_SET_ENVS=GITHUB_SHA GITHUB_SHA= \
          cargo green -vv install --jobs=1 --locked --force bottom@0.11.4  |& tee _
    - if: ${{ always() && matrix.toolchain != '1.91.1' }}
      uses: actions/upload-artifact@v7
      name: Upload recipe
      with:
        name: bottom@0.11.4.Dockerfile
        path: ${{ env.CARGOGREEN_FINAL_PATH }}
        if-no-files-found: error
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH
    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

    - name: ðŸ”µ Ensure running the same command twice without modifications...
      run: |
        unset CARGO_PROFILE_DEV_DEBUG
        unset CARGO_REGISTRIES_CRATES_IO_PROTOCOL
        unset CARGO_TERM_COLOR
        unset CARGO_UNSTABLE_SPARSE_REGISTRY
        env CARGOGREEN_SET_ENVS=GITHUB_SHA GITHUB_SHA= \
          cargo green -vv install --locked --force bottom@0.11.4  |& tee _
    - name: ...doesn't recompile anything
      run: |
        err=0
        grep Finished  _
        grep Finished  _ | grep -E [012]...s || ((err+=1))
        grep Dirty     _                     && ((err+=2))
        grep Compiling _                     && ((err+=4))
        exit $err
    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that cargo issue https://github.com/rust-lang/cargo/pull/14322
      run: |
        ! grep -C20 -F 'src/cargo/util/dependency_queue.rs:' _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's again that docker issue https://github.com/moby/buildkit/issues/5217
      run: |
        ! grep -C20 -F 'ResourceExhausted: grpc: received message larger than max' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> it's this HTTP/2 code = Unavailable desc = error reading from server-- connection error-- COMPRESSION_ERROR
      run: |
        ! grep -C20 -F 'connection error: COMPRESSION_ERROR' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some panic!s
      run: |
        ! grep -C20 -F ' panicked at ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> there's some BUGs
      run: |
        ! grep -C20 -F 'BUG: ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's cargo's error text
      run: |
        ! grep -C20 -E '-[a-f0-9]{16} [eE]rror:' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> 429 Too Many Requests
      run: |
        ! grep -C20 -F '429 Too Many Requests' $CARGOGREEN_LOG_PATH _

    - if: ${{ always() }}
      name: ðŸ”´ =means=> here's relevant logs
      run: |
        ! grep -C20 -F ' >>> ' $CARGOGREEN_LOG_PATH

    - if: ${{ always() && env.CARGOGREEN_FINAL_PATH != '' }}
      name: ðŸŒ€ Maybe show final path diff
      run: |
        case "$GITHUB_JOB" in
          cross*|ntpd*) exit 0 ;; # TODO: fix undeterministic final paths for git crates
          *) ;;
        esac
        final_diff=(git --no-pager diff)
        if [[ ${{ matrix.toolchain }} != 1.91.1 ]]; then
          final_diff+=(--exit-code)
        fi
        final_diff+=(--ignore-matching-lines='^#')
        final_diff+=(--ignore-matching-lines=' AS rust-base$')
        final_diff+=(--ignore-matching-lines=' NUM_JOBS=')
        final_diff+=(-- $CARGOGREEN_FINAL_PATH)
        "${final_diff[@]}"

    - if: ${{ failure() }}
      name: ðŸŒ€ cargo-green logs
      run: tail -n9999999 $CARGOGREEN_LOG_PATH ; echo >$CARGOGREEN_LOG_PATH

    - name: ðŸ”µ Compare old/new local private registry image digests
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        diff --width=150 -y \
          <(find /tmp/.local-registry/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) \
          <(find /tmp/.local-registry-new/docker/registry/v2/blobs/sha256/??/ -type d | awk -F/ '{print $NF}' | sort -u) || true
        du -sh /tmp/.local-registry /tmp/.local-registry-new || true
    - name: Local private registry cache dance
      if: ${{ always() && env.CARGOGREEN_CACHE_FROM_IMAGES != '' && env.CARGOGREEN_CACHE_TO_IMAGES != '' }}
      run: |
        # [ci: caches keep growing](https://github.com/moby/buildkit/issues/1850)
        docker stop --timeout 10 reg-from reg-to
        rm -rf /tmp/.local-registry
        mv /tmp/.local-registry-new /tmp/.local-registry
    - name: Save local private registry cache
      uses: actions/cache/save@v5
      if: ${{ false }} # TODO: drop when digests are stable
      with:
        path: /tmp/.local-registry
        key: localprivatereg-${{ runner.os }}-${{ matrix.toolchain }}-${{ github.job }}-${{ github.run_id }}

    - run: sudo du -sh /var/lib/docker || true
    - run: docker system df
    - run: docker system df --verbose
    - run: BUILDX_BUILDER=supergreen docker buildx du | head || true
    - run: BUILDX_BUILDER=supergreen docker buildx du | tail || true
    - run: BUILDX_BUILDER=supergreen docker buildx du --verbose

    - name: Target dir disk usage
      if: ${{ always() }}
      run: du -sh $CARGO_TARGET_DIR || true

